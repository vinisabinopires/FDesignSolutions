<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Workspace · F/Design Solutions</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --bg-alt: #1e293b;
      --card: rgba(15, 23, 42, 0.78);
      --card-border: rgba(148, 163, 184, 0.2);
      --accent: #fbbc04;
      --primary: #2b5797;
      --text: #f8fafc;
      --muted: rgba(241, 245, 249, 0.7);
      color-scheme: dark;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top right, rgba(251, 188, 4, 0.18), rgba(43, 87, 151, 0.28)), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 28px 48px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 18px;
    }
    .brand h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 600;
    }
    .brand span {
      font-size: 0.95rem;
      color: var(--muted);
    }
    .user-box {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), var(--primary));
      display: grid;
      place-items: center;
      font-weight: 700;
      font-size: 1.2rem;
      color: #111827;
    }
    button.logout {
      border: none;
      padding: 10px 18px;
      border-radius: 12px;
      background: rgba(248, 113, 113, 0.16);
      color: #fca5a5;
      cursor: pointer;
      font-weight: 600;
    }
    main {
      flex: 1;
      padding: 0 48px 48px;
    }
    .grid {
      display: grid;
      gap: 24px;
    }
    .grid.metrics {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      margin-bottom: 36px;
    }
    .grid.actions {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.32);
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 0.95rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .card .value {
      font-size: 2rem;
      font-weight: 600;
    }
    .actions button {
      width: 100%;
      border: none;
      border-radius: 18px;
      padding: 18px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #0f172a;
      background: linear-gradient(135deg, rgba(251, 188, 4, 0.9), rgba(236, 175, 43, 0.9));
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .actions button.secondary {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.85), rgba(99, 102, 241, 0.85));
      color: #f8fafc;
    }
    .actions button:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.28);
    }
    .charts {
      display: grid;
      gap: 24px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      margin-top: 36px;
    }
    .chart {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 20px;
      min-height: 320px;
    }
    .state {
      text-align: center;
      padding: 80px 20px;
      color: var(--muted);
    }
    @media (max-width: 768px) {
      header, main { padding: 24px; }
      .brand h1 { font-size: 1.4rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div>
        <h1>F/Design Solutions</h1>
        <span>Sales excellence hub</span>
      </div>
    </div>
    <div class="user-box">
      <div id="userAvatar" class="avatar">U</div>
      <div>
        <div id="userName" style="font-weight:600; font-size:1rem;">User</div>
        <div id="welcomeMessage" style="font-size:0.85rem; color:var(--muted);">Loading workspace…</div>
      </div>
      <button class="logout" type="button" onclick="logout()">Sign out</button>
    </div>
  </header>

  <main>
    <section id="loadingState" class="state">Loading your metrics…</section>
    <section id="errorState" class="state" style="display:none;"></section>

    <div id="dashboardContent" style="display:none;">
      <div class="grid metrics">
        <div class="card">
          <h2>Total Sales</h2>
          <div id="totalVendas" class="value">$0.00</div>
        </div>
        <div class="card">
          <h2>Total Commission</h2>
          <div id="totalComissoes" class="value">$0.00</div>
        </div>
        <div class="card">
          <h2>Active Quotes</h2>
          <div id="totalOrcamentos" class="value">0</div>
        </div>
        <div class="card">
          <h2>Conversion Rate</h2>
          <div id="taxaConversao" class="value">0%</div>
        </div>
      </div>

      <div class="grid actions">
        <button type="button" onclick="openModal('abrirFormVendas')">
          New sale
          <span>→</span>
        </button>
        <button type="button" class="secondary" onclick="openModal('abrirDashboardVendas')">
          Sales dashboard
          <span>→</span>
        </button>
        <button type="button" class="secondary" onclick="openModal('abrirFormGerenciar')">
          Quotes pipeline
          <span>→</span>
        </button>
        <button id="adminCard" type="button" class="secondary" style="display:none;" onclick="openModal('abrirPainelAdmin')">
          Admin control center
          <span>→</span>
        </button>
      </div>

      <div class="charts">
        <div class="chart">
          <h2 style="margin:0 0 12px;">Sales performance</h2>
          <div id="chartVendasMensal" style="width:100%; height:260px;"></div>
        </div>
        <div class="chart">
          <h2 style="margin:0 0 12px;">Quotes by status</h2>
          <div id="chartOrcamentos" style="width:100%; height:260px;"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let dashboardData = null;
    google.charts.load('current', { packages: ['corechart', 'bar'] });

    document.addEventListener('DOMContentLoaded', () => {
      loadDashboard();
    });

    function loadDashboard() {
      google.script.run
        .withSuccessHandler(onDashboardLoaded)
        .withFailureHandler((error) => showError('Unable to load dashboard data.'))
        .obterDadosDashboard();
    }

    function onDashboardLoaded(data) {
      if (!data || data.erro) {
        showError(data?.mensagem || 'Unable to load dashboard data.');
        return;
      }
      dashboardData = data;
      renderDashboard(data);
      verifyPermissions();
    }

    function renderDashboard(data) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'block';
      document.getElementById('errorState').style.display = 'none';

      document.getElementById('userName').textContent = data.nome || 'Seller';
      document.getElementById('userAvatar').textContent = (data.nome || 'U').charAt(0).toUpperCase();
      document.getElementById('welcomeMessage').textContent = `Great to see you, ${data.nome || 'seller'}!`;

      document.getElementById('totalVendas').textContent = `$${Number(data.totalVendas).toFixed(2)}`;
      document.getElementById('totalComissoes').textContent = `$${Number(data.totalComissao).toFixed(2)}`;
      document.getElementById('totalOrcamentos').textContent = data.totalOrcamentos;

      const conversion = Number(data.taxaConversao || 0);
      document.getElementById('taxaConversao').textContent = `${conversion.toFixed(0)}%`;


      google.charts.setOnLoadCallback(() => {
        drawSalesChart(data.graficoVendas);
        drawQuotesChart(data.graficoOrcamentos);
      });
    }

    function drawSalesChart(rows) {
      const container = document.getElementById('chartVendasMensal');
      if (!rows || rows.length <= 1) {
        container.innerHTML = '<div style="text-align:center; color:var(--muted); padding:40px 0;">No sales data yet</div>';
        return;
      }
      const chartData = google.visualization.arrayToDataTable(rows);
      const options = {
        legend: { position: 'none' },
        colors: ['#fbbc04'],
        backgroundColor: 'transparent',
        hAxis: { textStyle: { color: '#94a3b8' } },
        vAxis: { textStyle: { color: '#94a3b8' } },
      };
      new google.visualization.ColumnChart(container).draw(chartData, options);
    }

    function drawQuotesChart(rows) {
      const container = document.getElementById('chartOrcamentos');
      if (!rows || rows.length <= 1) {
        container.innerHTML = '<div style="text-align:center; color:var(--muted); padding:40px 0;">No quotes registered</div>';
        return;
      }
      const chartData = google.visualization.arrayToDataTable(rows);
      const options = {
        pieHole: 0.45,
        backgroundColor: 'transparent',
        legend: { textStyle: { color: '#94a3b8' } },
        slices: {
          0: { color: '#2dd4bf' },
          1: { color: '#f97316' },
          2: { color: '#f87171' },
          3: { color: '#6366f1' },
        },
      };
      new google.visualization.PieChart(container).draw(chartData, options);
    }

    function verifyPermissions() {
      google.script.run
        .withSuccessHandler((permissions) => {
          if (permissions?.autenticado && permissions?.podeGerenciar) {
            document.getElementById('adminCard').style.display = 'block';
          }
        })
        .withFailureHandler(() => {})
        .obterPermissoesAtuais();
    }

    function openModal(action) {
      const runner = google.script.run
        .withSuccessHandler(() => {})
        .withFailureHandler(() => alert('Unable to open module.'));

      switch (action) {
        case 'abrirFormVendas':
          runner.abrirFormVendas();
          break;
        case 'abrirDashboardVendas':
          runner.abrirDashboardVendas();
          break;
        case 'abrirFormGerenciar':
          runner.abrirFormGerenciar();
          break;
        case 'abrirPainelAdmin':
          runner.abrirPainelAdmin();
          break;
        default:
          alert('Module not available.');
      }
    }

    function logout() {
      if (!confirm('Do you want to sign out?')) return;
      google.script.run
        .withSuccessHandler(() => google.script.host.close())
        .withFailureHandler(() => alert('Unable to sign out.'))
        .encerrarSessao();
    }

    function showError(message) {
      document.getElementById('loadingState').style.display = 'none';
      const errorEl = document.getElementById('errorState');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      document.getElementById('dashboardContent').style.display = 'none';
    }
  </script>
</body>
</html>
