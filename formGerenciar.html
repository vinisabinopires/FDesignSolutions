<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Sales · F/Design Solutions</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f1f5f9;
      --card: #ffffff;
      --border: rgba(148, 163, 184, 0.35);
      --primary: #2b5797;
      --accent: #fbbc04;
      --danger: #dc2626;
      --success: #16a34a;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, rgba(43, 87, 151, 0.08), rgba(251, 188, 4, 0.08)), var(--bg);
      min-height: 100vh;
      padding: 40px;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: var(--card);
      border-radius: 24px;
      padding: 32px 38px;
      border: 1px solid var(--border);
      box-shadow: 0 24px 50px rgba(15, 23, 42, 0.12);
    }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    header h1 { margin: 0; font-size: 1.8rem; color: var(--primary); }
    header p { margin: 6px 0 0; color: #475569; }
    button.ghost { border: none; background: none; color: var(--primary); font-weight: 600; cursor: pointer; }
    form#searchForm { display: flex; gap: 12px; margin-bottom: 20px; }
    form#searchForm input {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1.5px solid var(--border);
    }
    button.primary {
      background: linear-gradient(135deg, var(--accent), #ffd250);
      color: #111827;
      border: none;
      border-radius: 12px;
      padding: 12px 18px;
      font-weight: 600;
      cursor: pointer;
    }
    .message { display: none; padding: 14px; border-radius: 14px; margin-bottom: 18px; border-left: 4px solid transparent; }
    .message.success { background: #f0fdf4; border-color: var(--success); color: var(--success); }
    .message.error { background: #fef2f2; border-color: var(--danger); color: var(--danger); }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 12px 14px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); text-align: left; }
    th { color: #475569; font-weight: 600; }
    .actions button { border: none; border-radius: 10px; padding: 8px 12px; font-weight: 600; cursor: pointer; }
    .btn-edit { background: rgba(37, 99, 235, 0.16); color: #1d4ed8; }
    .btn-delete { background: rgba(220, 38, 38, 0.16); color: #b91c1c; }
    .empty { padding: 24px; text-align: center; color: #64748b; }

    .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); display: none; align-items: center; justify-content: center; }
    .modal-content { background: #ffffff; border-radius: 20px; width: min(520px, 90vw); padding: 28px; box-shadow: 0 24px 50px rgba(15, 23, 42, 0.22); }
    .modal-content h2 { margin-top: 0; color: var(--primary); }
    .modal-content form { display: grid; gap: 14px; }
    .modal-content label { font-weight: 500; color: #1f2937; }
    .modal-content input, .modal-content select { width: 100%; padding: 12px; border-radius: 12px; border: 1.5px solid var(--border); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 18px; }
    button.secondary { border: none; background: #e2e8f0; border-radius: 12px; padding: 10px 16px; font-weight: 600; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Manage sales</h1>
        <p>Locate, edit or remove sales records directly from Client_List.</p>
      </div>
      <button class="ghost" type="button" onclick="returnToHub()">← Back to workspace</button>
    </header>

    <form id="searchForm">
      <input id="searchTerm" placeholder="Search by sale ID or invoice" required />
      <button class="primary" type="submit">Search</button>
    </form>

    <div id="successMessage" class="message success"></div>
    <div id="errorMessage" class="message error"></div>

    <div id="loadingState" style="display:none; color:#475569;">Loading…</div>

    <table id="resultsTable" style="display:none;">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Client</th>
          <th>Company</th>
          <th>Invoice</th>
          <th>Product</th>
          <th>Value</th>
          <th>Commission</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>

    <div id="emptyState" class="empty">Search for a sale to view results.</div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <h2>Edit sale</h2>
      <form id="editForm">
        <input id="editRow" type="hidden" />
        <div>
          <label for="editTipo">Sale type</label>
          <select id="editTipo">
            <option value="New">New customer</option>
            <option value="Old">Returning customer</option>
            <option value="Walk-in">Walk-in</option>
          </select>
        </div>
        <div>
          <label for="editCliente">Client</label>
          <input id="editCliente" required />
        </div>
        <div>
          <label for="editEmpresa">Company</label>
          <input id="editEmpresa" />
        </div>
        <div>
          <label for="editInvoice">Invoice</label>
          <input id="editInvoice" required />
        </div>
        <div>
          <label for="editProduto">Product</label>
          <input id="editProduto" required />
        </div>
        <div>
          <label for="editValor">Value ($)</label>
          <input id="editValor" type="number" step="0.01" min="0" required />
        </div>
        <div class="modal-actions">
          <button class="secondary" type="button" onclick="closeModal()">Cancel</button>
          <button class="primary" type="submit">Save changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentSale = null;

    document.getElementById('searchForm').addEventListener('submit', handleSearch);
    document.getElementById('editForm').addEventListener('submit', handleEdit);

    function handleSearch(event) {
      event.preventDefault();
      const term = document.getElementById('searchTerm').value.trim();
      if (!term) {
        showError('Enter a sale ID or invoice.');
        return;
      }
      setLoading(true);
      google.script.run
        .withSuccessHandler((result) => {
          setLoading(false);
          renderResult(result);
        })
        .withFailureHandler((error) => {
          setLoading(false);
          showError('Unable to search for the sale.');
          console.error(error);
        })
        .buscarVenda(term);
    }

    function renderResult(result) {
      const table = document.getElementById('resultsTable');
      const body = document.getElementById('resultsBody');
      body.innerHTML = '';
      if (!result) {
        table.style.display = 'none';
        document.getElementById('emptyState').textContent = 'No sale found with this identifier.';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }
      currentSale = result;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${formatDate(result.data)}</td>
        <td>${result.tipo || '-'}</td>
        <td>${result.cliente || '-'}</td>
        <td>${result.empresa || '-'}</td>
        <td>${result.invoice || result.id || '-'}</td>
        <td>${result.produto || '-'}</td>
        <td>$${Number(result.valor || 0).toFixed(2)}</td>
        <td>$${Number(result.percentual || 0).toFixed(2)}</td>
        <td class="actions">
          <button class="btn-edit" type="button" onclick="openEdit()">Edit</button>
          <button class="btn-delete" type="button" onclick="deleteSale()">Delete</button>
        </td>
      `;
      body.appendChild(row);
      table.style.display = 'table';
      document.getElementById('emptyState').style.display = 'none';
    }

    function openEdit() {
      if (!currentSale) return;
      document.getElementById('editRow').value = currentSale.linha;
      document.getElementById('editTipo').value = currentSale.tipo || 'New';
      document.getElementById('editCliente').value = currentSale.cliente || '';
      document.getElementById('editEmpresa').value = currentSale.empresa || '';
      document.getElementById('editInvoice').value = currentSale.invoice || currentSale.id || '';
      document.getElementById('editProduto').value = currentSale.produto || '';
      document.getElementById('editValor').value = Number(currentSale.valor || 0);
      document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    function handleEdit(event) {
      event.preventDefault();
      const payload = {
        linha: document.getElementById('editRow').value,
        tipo: document.getElementById('editTipo').value,
        cliente: document.getElementById('editCliente').value.trim(),
        empresa: document.getElementById('editEmpresa').value.trim(),
        invoice: document.getElementById('editInvoice').value.trim(),
        produto: document.getElementById('editProduto').value.trim(),
        valor: parseFloat(document.getElementById('editValor').value || '0'),
      };

      google.script.run
        .withSuccessHandler((res) => {
          showSuccess(res.message || 'Sale updated successfully.');
          closeModal();
          refreshResult();
        })
        .withFailureHandler((error) => {
          showError('Unable to update the sale.');
          console.error(error);
        })
        .atualizarVenda(payload);
    }

    function deleteSale() {
      if (!currentSale) return;
      if (!confirm('Delete this sale permanently?')) return;
      google.script.run
        .withSuccessHandler((res) => {
          showSuccess(res.message || 'Sale removed.');
          document.getElementById('resultsTable').style.display = 'none';
          document.getElementById('emptyState').textContent = 'Sale removed. Search again to continue.';
          document.getElementById('emptyState').style.display = 'block';
        })
        .withFailureHandler(() => showError('Unable to delete the sale.'))
        .excluirVenda(currentSale.linha);
    }

    function showSuccess(message) {
      const success = document.getElementById('successMessage');
      success.textContent = message;
      success.style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';
    }

    function showError(message) {
      const error = document.getElementById('errorMessage');
      error.textContent = message;
      error.style.display = 'block';
      document.getElementById('successMessage').style.display = 'none';
    }

    function setLoading(state) {
      document.getElementById('loadingState').style.display = state ? 'block' : 'none';
    }

    function formatDate(value) {
      if (!value) return '-';
      try {
        const date = value instanceof Date ? value : new Date(value);
        if (isNaN(date.getTime())) return '-';
        return date.toLocaleDateString();
      } catch (error) {
        return '-';
      }
    }


    function refreshResult() {
            const term = (currentSale && currentSale.id) || document.getElementById('searchTerm').value.trim();
      if (!term) return;
      setLoading(true);
      google.script.run
        .withSuccessHandler((result) => {
          setLoading(false);
          renderResult(result);
        })
        .withFailureHandler(() => {
          setLoading(false);
          showError('Unable to refresh the sale.');
        })
        .buscarVenda(term);
    }
    function returnToHub() {
      google.script.run
        .withSuccessHandler(() => google.script.host.close())
        .withFailureHandler(() => showError('Unable to return to the workspace.'))
        .retornarAoMenuPrincipal();
    }
  </script>
</body>
</html>
