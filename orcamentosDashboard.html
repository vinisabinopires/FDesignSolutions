<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quotes Pipeline · F/Design Solutions</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #111827;
      --card: rgba(17, 24, 39, 0.92);
      --border: rgba(148, 163, 184, 0.2);
      --accent: #38bdf8;
      --warning: #f97316;
      --danger: #ef4444;
      color-scheme: dark;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.25), rgba(17, 24, 39, 0.95));
      color: #e2e8f0;
      min-height: 100vh;
      padding: 36px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    header { display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 1.75rem; }
    header p { margin: 6px 0 0; color: rgba(148, 163, 184, 0.8); }
    .primary {
      background: linear-gradient(135deg, var(--accent), #60a5fa);
      color: #0f172a;
      border: none;
      border-radius: 14px;
      padding: 12px 18px;
      font-weight: 600;
      cursor: pointer;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.4);
    }
    .search-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 18px;
    }
    input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.5);
      color: #e2e8f0;
    }
    input::placeholder { color: rgba(148, 163, 184, 0.6); }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 12px 14px; border-bottom: 1px solid rgba(148, 163, 184, 0.15); text-align: left; }
    th { color: rgba(148, 163, 184, 0.9); font-weight: 600; }
    tr:hover { background: rgba(56, 189, 248, 0.15); cursor: pointer; }
    .empty { text-align: center; padding: 24px; color: rgba(148, 163, 184, 0.65); }

    .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.86); display: none; align-items: center; justify-content: center; }
    .modal-content {
      background: var(--card);
      border-radius: 20px;
      border: 1px solid var(--border);
      width: min(520px, 92vw);
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { margin: 0; font-size: 1.3rem; }
    .close-btn { background: none; border: none; color: rgba(148, 163, 184, 0.8); font-size: 1.6rem; cursor: pointer; }
    .actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
    .actions button { border: none; border-radius: 12px; padding: 12px; font-weight: 600; cursor: pointer; }
    .btn-call { background: rgba(56, 189, 248, 0.18); color: #bae6fd; }
    .btn-msg { background: rgba(45, 212, 191, 0.18); color: #5eead4; }
    .btn-convert { background: rgba(250, 204, 21, 0.18); color: #fcd34d; }
    .btn-lost { background: rgba(248, 113, 113, 0.18); color: #fecaca; }
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 18px; border-radius: 12px; background: rgba(56, 189, 248, 0.95); color: #0f172a; font-weight: 600; display: none; }
    .toast.error { background: rgba(248, 113, 113, 0.95); color: #111827; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Quotes pipeline</h1>
      <p>Track every opportunity and convert them into sales in a single click.</p>
    </div>
    <button class="primary" type="button" onclick="returnToHub()">← Back to workspace</button>
  </header>

  <section class="card">
    <div class="search-grid">
      <input id="searchClient" placeholder="Client" />
      <input id="searchCompany" placeholder="Company" />
      <input id="searchQuote" placeholder="Quote ID" />
      <input id="searchProduct" placeholder="Product" />
    </div>
    <button class="primary" type="button" onclick="searchQuotes()">Search quotes</button>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Client</th>
          <th>Company</th>
          <th>Product</th>
          <th>Value</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="quotesBody">
        <tr><td class="empty" colspan="6">Use the filters above to load quotes.</td></tr>
      </tbody>
    </table>
  </section>

  <div id="quoteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="quoteTitle">Quote details</h2>
        <button class="close-btn" type="button" onclick="closeModal()">×</button>
      </div>
      <div id="quoteInfo" style="font-size:0.95rem; line-height:1.5;"></div>
      <div class="actions">
        <button class="btn-call" type="button" onclick="addContact('Call')">Log call</button>
        <button class="btn-msg" type="button" onclick="addContact('Message')">Log message</button>
        <button class="btn-convert" type="button" onclick="convertQuote()">Convert to sale</button>
        <button class="btn-lost" type="button" onclick="markLost()">Mark as lost</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    let currentQuote = null;

    function searchQuotes() {
      const filters = {
        nome: document.getElementById('searchClient').value.trim(),
        empresa: document.getElementById('searchCompany').value.trim(),
        invoice: document.getElementById('searchQuote').value.trim(),
        produto: document.getElementById('searchProduct').value.trim(),
      };

      google.script.run
        .withSuccessHandler(renderQuotes)
        .withFailureHandler(() => showToast('Unable to load quotes.', true))
        .buscarOrcamentos(filters);
    }

    function renderQuotes(quotes) {
      const body = document.getElementById('quotesBody');
      body.innerHTML = '';
      if (!quotes || quotes.length === 0) {
        body.innerHTML = '<tr><td class="empty" colspan="6">No quotes found.</td></tr>';
        return;
      }
      quotes.forEach((quote) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${quote.id || ''}</td>
          <td>${quote.cliente || '-'}</td>
          <td>${quote.empresa || '-'}</td>
          <td>${quote.produto || '-'}</td>
          <td>$${Number(quote.valor || 0).toFixed(2)}</td>
          <td>${quote.status || '-'}</td>
        `;
        row.addEventListener('click', () => openQuote(quote));
        body.appendChild(row);
      });
    }

    function openQuote(quote) {
      currentQuote = quote;
      document.getElementById('quoteTitle').textContent = `Quote ${quote.id}`;
      document.getElementById('quoteInfo').innerHTML = `
        <strong>Client:</strong> ${quote.cliente || '-'}<br />
        <strong>Company:</strong> ${quote.empresa || '-'}<br />
        <strong>Product:</strong> ${quote.produto || '-'}<br />
        <strong>Value:</strong> $${Number(quote.valor || 0).toFixed(2)}<br />
        <strong>Status:</strong> ${quote.status || '-'}<br />
        <strong>Attempts:</strong> ${quote.tentativas || 0}
      `;
      document.getElementById('quoteModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('quoteModal').style.display = 'none';
      currentQuote = null;
    }

    function addContact(type) {
      if (!currentQuote) return;
      google.script.run
        .withSuccessHandler((res) => {
          showToast(`${type} logged. Attempts: ${res.tentativas}`);
          searchQuotes();
        })
        .withFailureHandler(() => showToast('Unable to log contact.', true))
        .registrarTentativaContato(currentQuote.id, type);
    }

    function convertQuote() {
      if (!currentQuote) return;
      google.script.run
        .withSuccessHandler((res) => {
          showToast(`Quote converted into sale ${res.idVenda}`);
          closeModal();
          searchQuotes();
        })
        .withFailureHandler(() => showToast('Unable to convert quote.', true))
        .converterOrcamentoParaVenda(currentQuote.id);
    }

    function markLost() {
      showToast('Quote marked as lost.');
      closeModal();
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast${isError ? ' error' : ''}`;
      toast.style.display = 'block';
      setTimeout(() => (toast.style.display = 'none'), 2600);
    }

    function returnToHub() {
      google.script.run
        .withSuccessHandler(() => google.script.host.close())
        .withFailureHandler(() => showToast('Unable to return.', true))
        .retornarAoMenuPrincipal();
    }
  </script>
</body>
</html>
