<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quotes Dashboard — F/Design Solutions</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; font-family: 'Nunito Sans', sans-serif; }
    body {
      margin: 0; min-height: 100vh; color: #fff;
      background: linear-gradient(135deg, #1b2b5a, #283f87, #2b5797);
      background-size: 300% 300%;
      animation: gradientShift 18s ease infinite;
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      padding: 30px;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .dashboard {
      width: 95%; max-width: 1000px;
      background: rgba(255, 255, 255, 0.07);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px 40px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.35);
      backdrop-filter: blur(14px);
      animation: fadeIn 0.8s ease;
    }
    @keyframes fadeIn { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }

    h1 {
      font-weight: 800; font-size: 2rem; margin: 0 0 6px;
    }
    .subtext {
      color: #e0e6f7; font-size: 1.1rem; margin-bottom: 25px;
    }

    .search-section {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px; margin-bottom: 25px;
    }
    input {
      padding: 12px 16px; border-radius: 10px; border: none; font-size: 1rem;
      background: rgba(255,255,255,0.15); color: #fff;
    }
    input::placeholder { color: rgba(255,255,255,0.6); }
    button {
      padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer;
      font-weight: 700; font-size: 1rem; transition: all 0.25s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, #fbbc04, #ffcc33);
      color: #222;
    }
    .btn-primary:hover { transform: translateY(-2px); }

    table {
      width: 100%; border-collapse: collapse; margin-top: 10px;
      background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden;
    }
    th, td {
      padding: 12px 14px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    th { font-weight: 700; color: #ffdf85; background: rgba(255,255,255,0.08); }
    tr:hover { background: rgba(255,255,255,0.12); cursor: pointer; }

    .empty {
      text-align: center; padding: 25px; font-style: italic; color: rgba(255,255,255,0.6);
    }

    /* MODAL */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      display: none; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background: #fff; color: #222; border-radius: 14px; width: 95%; max-width: 550px;
      padding: 25px 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      animation: popIn 0.3s ease;
    }
    @keyframes popIn { from{opacity:0;transform:scale(0.95);} to{opacity:1;transform:scale(1);} }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid #ddd; margin-bottom: 15px; padding-bottom: 10px;
    }
    .modal-header h2 { font-size: 1.4rem; margin: 0; }
    .close-btn { background:none;border:none;font-size:1.6rem;cursor:pointer; }

    .action-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .action-buttons button {
      flex: 1 1 45%; padding: 10px; font-weight: 600;
      border-radius: 8px; border: none;
    }
    .btn-call { background: #0ea5e9; color: #fff; }
    .btn-msg { background: #10b981; color: #fff; }
    .btn-convert { background: #fbbc04; color: #000; }
    .btn-lost { background: #dc2626; color: #fff; }

    .toast {
      position: fixed; bottom: 20px; right: 20px; padding: 12px 18px;
      border-radius: 8px; font-weight: 600; display: none;
    }
    .toast.success { background: #16a34a; color: #fff; }
    .toast.error { background: #dc2626; color: #fff; }
  </style>
</head>

<body>
  <div class="dashboard">
    <h1>Quotes Dashboard</h1>
    <p class="subtext">Search, manage, and convert client quotes.</p>

    <div class="search-section">
      <input id="searchClient" placeholder="Client name">
      <input id="searchCompany" placeholder="Company">
      <input id="searchQuote" placeholder="Quote ID">
      <input id="searchProduct" placeholder="Product">
      <button class="btn-primary" onclick="searchQuotes()">Search</button>
    </div>

    <table id="quotesTable">
      <thead>
        <tr>
          <th>ID</th><th>Client</th><th>Company</th><th>Product</th><th>Value</th><th>Status</th>
        </tr>
      </thead>
      <tbody id="quotesBody">
        <tr><td colspan="6" class="empty">No results found</td></tr>
      </tbody>
    </table>
  </div>

  <!-- MODAL -->
  <div id="quoteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="quoteTitle">Quote Details</h2>
        <button class="close-btn" onclick="closeModal()">×</button>
      </div>
      <div id="quoteInfo"></div>

      <div class="action-buttons">
        <button class="btn-call" onclick="addContact('Call')">+ Call</button>
        <button class="btn-msg" onclick="addContact('Message')">+ Message</button>
        <button class="btn-convert" onclick="convertQuote()">Convert to Sale</button>
        <button class="btn-lost" onclick="markLost()">Mark as Lost</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    let currentQuote = null;

    function searchQuotes() {
      const filtros = {
        nome: document.getElementById('searchClient').value.trim(),
        empresa: document.getElementById('searchCompany').value.trim(),
        invoice: document.getElementById('searchQuote').value.trim(),
        produto: document.getElementById('searchProduct').value.trim(),
      };

      google.script.run
        .withSuccessHandler(renderQuotes)
        .withFailureHandler(() => showToast('Error searching quotes', 'error'))
        .buscarOrcamentos(filtros);
    }

    function renderQuotes(quotes) {
      const tbody = document.getElementById('quotesBody');
      tbody.innerHTML = '';

      if (!quotes || quotes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty">No results found</td></tr>';
        return;
      }

      quotes.forEach(q => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${q.id}</td>
          <td>${q.cliente}</td>
          <td>${q.empresa}</td>
          <td>${q.produto}</td>
          <td>$${parseFloat(q.valor).toFixed(2)}</td>
          <td>${q.status}</td>
        `;
        row.onclick = () => openQuoteDetails(q);
        tbody.appendChild(row);
      });
    }

    function openQuoteDetails(quote) {
      currentQuote = quote;
      document.getElementById('quoteTitle').textContent = `Quote #${quote.id}`;
      document.getElementById('quoteInfo').innerHTML = `
        <p><strong>Client:</strong> ${quote.cliente}</p>
        <p><strong>Company:</strong> ${quote.empresa}</p>
        <p><strong>Product:</strong> ${quote.produto}</p>
        <p><strong>Value:</strong> $${parseFloat(quote.valor).toFixed(2)}</p>
        <p><strong>Status:</strong> ${quote.status}</p>
        <p><strong>Attempts:</strong> ${quote.tentativas || 0}</p>
      `;
      document.getElementById('quoteModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('quoteModal').style.display = 'none';
    }

    function addContact(type) {
      if (!currentQuote) return;
      google.script.run
        .withSuccessHandler(res => {
          showToast(`${type} logged (${res.tentativas} total)`, 'success');
          searchQuotes();
        })
        .withFailureHandler(() => showToast('Error adding contact', 'error'))
        .registrarTentativaContato(currentQuote.id, type);
    }

    function convertQuote() {
      if (!currentQuote) return;
      google.script.run
        .withSuccessHandler(res => {
          showToast(`Quote converted to Sale: ${res.idVenda}`, 'success');
          searchQuotes();
        })
        .withFailureHandler(() => showToast('Error converting quote', 'error'))
        .converterOrcamentoParaVenda(currentQuote.id);
      closeModal();
    }

    function markLost() {
      showToast('Quote marked as Lost ❌', 'success');
      closeModal();
    }

    function showToast(msg, type) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = `toast ${type}`;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 2500);
    }
  </script>
</body>
</html>
