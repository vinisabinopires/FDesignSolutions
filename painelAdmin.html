<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Administrativo — F/Design Solutions</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #f4f6fb;
      color: #1f2933;
    }

    header {
      background: linear-gradient(135deg, #2b5797, #1b365d);
      color: #fff;
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(18, 52, 86, 0.25);
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    header button {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.4);
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s ease;
    }

    header button:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .tabs {
      display: flex;
      gap: 12px;
      padding: 16px 24px 0 24px;
    }

    .tab-button {
      background: #e3e8f8;
      border: none;
      color: #1b365d;
      padding: 10px 16px;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab-button.active {
      background: #2b5797;
      color: #fff;
      box-shadow: 0 6px 12px rgba(43, 87, 151, 0.3);
    }

    main {
      padding: 16px 24px 32px 24px;
    }

    section {
      display: none;
    }

    section.active {
      display: block;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 18px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: #fff;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 4px 10px rgba(23, 42, 87, 0.08);
      border: 1px solid rgba(43, 87, 151, 0.1);
    }

    .kpi-card span {
      display: block;
      font-size: 13px;
      color: #5f6c80;
    }

    .kpi-card strong {
      display: block;
      margin-top: 8px;
      font-size: 22px;
      color: #1b365d;
    }

    .panel {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(15, 32, 67, 0.08);
      margin-bottom: 24px;
      overflow: hidden;
      border: 1px solid rgba(43, 87, 151, 0.12);
    }

    .panel header {
      background: none;
      color: inherit;
      box-shadow: none;
      padding: 20px 24px 0 24px;
    }

    .panel header h2 {
      margin: 0;
      font-size: 18px;
      color: #1b365d;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 320px;
    }

    thead {
      background: #eff3fb;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #e5e9f2;
      font-size: 13px;
    }

    th {
      font-weight: 600;
      color: #1b365d;
    }

    tbody tr:nth-child(odd) {
      background: #fafbff;
    }

    .status-pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      display: inline-block;
      font-weight: 600;
    }

    .status-ativo {
      background: rgba(34, 197, 94, 0.15);
      color: #15803d;
    }

    .status-inativo {
      background: rgba(248, 113, 113, 0.15);
      color: #b91c1c;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .setting-card {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 4px 10px rgba(23, 42, 87, 0.07);
      border: 1px solid rgba(43, 87, 151, 0.12);
    }

    .setting-card span {
      font-size: 12px;
      color: #61718a;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .setting-card strong {
      display: block;
      margin-top: 6px;
      font-size: 16px;
      color: #1b365d;
    }

    #loading {
      position: fixed;
      inset: 0;
      background: rgba(16, 27, 56, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.05em;
      z-index: 999;
    }

    #error {
      background: rgba(248, 113, 113, 0.15);
      color: #b91c1c;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: none;
    }

    .integrity-list {
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
      color: #b45309;
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      header button {
        align-self: stretch;
        text-align: center;
      }

      .tabs {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <div id="loading">Carregando painel...</div>
  <header>
    <h1>F/Design Solutions — Painel Administrativo</h1>
    <button type="button" id="refreshButton">Atualizar Dados</button>
  </header>
  <div class="tabs">
    <button class="tab-button active" data-target="overview">Visão Geral</button>
    <button class="tab-button" data-target="users">Usuários</button>
    <button class="tab-button" data-target="sales">Vendas</button>
    <button class="tab-button" data-target="budgets">Orçamentos</button>
    <button class="tab-button" data-target="settings">Configurações</button>
    <button class="tab-button" data-target="integrity">Integridade</button>
  </div>
  <main>
    <div id="error"></div>
    <section id="overview" class="active">
      <div class="kpi-grid" id="kpis"></div>
    </section>
    <section id="users">
      <div class="panel">
        <header><h2>Equipe e Usuários</h2></header>
        <div class="table-wrapper" id="usersTable"></div>
      </div>
    </section>
    <section id="sales">
      <div class="panel">
        <header><h2>Vendas Registradas</h2></header>
        <div class="table-wrapper" id="salesTable"></div>
      </div>
    </section>
    <section id="budgets">
      <div class="panel">
        <header><h2>Orçamentos</h2></header>
        <div class="table-wrapper" id="budgetsTable"></div>
      </div>
    </section>
    <section id="settings">
      <div class="panel">
        <header><h2>Parâmetros do Sistema</h2></header>
        <div class="settings-grid" id="settingsGrid"></div>
      </div>
    </section>
    <section id="integrity">
      <div class="panel">
        <header><h2>Alertas de Integridade</h2></header>
        <div class="table-wrapper">
          <ul class="integrity-list" id="integrityList"></ul>
        </div>
      </div>
    </section>
  </main>
  <script>
    (function () {
      var loadingEl = document.getElementById('loading');
      var errorEl = document.getElementById('error');
      var tabButtons = document.querySelectorAll('.tab-button');

      function setActiveTab(targetId) {
        for (var i = 0; i < tabButtons.length; i++) {
          var button = tabButtons[i];
          var isActive = button.getAttribute('data-target') === targetId;
          button.classList.toggle('active', isActive);
          var section = document.getElementById(button.getAttribute('data-target'));
          if (section) {
            section.classList.toggle('active', isActive);
          }
        }
      }

      function showError(message) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }

      function clearError() {
        errorEl.style.display = 'none';
        errorEl.textContent = '';
      }

      function formatCurrency(value) {
        var number = parseFloat(value);
        if (isNaN(number)) {
          return value === null || value === undefined || value === '' ? '-' : value;
        }
        return number.toLocaleString('pt-BR', { style: 'currency', currency: 'USD' });
      }

      function renderKPIs(kpis) {
        var container = document.getElementById('kpis');
        container.innerHTML = '';
        if (!kpis) {
          return;
        }
        var labelMap = {
          totalSales: 'Total de Vendas',
          totalBudgets: 'Orçamentos Registrados',
          totalUsers: 'Usuários Ativos',
          conversionRate: 'Taxa de Conversão',
          empresa: 'Empresa'
        };
        var keys = Object.keys(kpis);
        for (var i = 0; i < keys.length; i++) {
          var key = keys[i];
          var card = document.createElement('div');
          card.className = 'kpi-card';
          var title = document.createElement('span');
          title.textContent = labelMap[key] ? labelMap[key] : key.replace(/([A-Z])/g, ' $1').trim();
          var value = document.createElement('strong');
          var content = kpis[key];
          if (key === 'totalSales') {
            value.textContent = formatCurrency(content);
          } else {
            value.textContent = content;
          }
          card.appendChild(title);
          card.appendChild(value);
          container.appendChild(card);
        }
      }

      function renderTable(data, containerId) {
        var container = document.getElementById(containerId);
        container.innerHTML = '';
        if (!data || !data.length) {
          container.innerHTML = '<p style="padding:16px;color:#61718a;">Nenhum registro disponível.</p>';
          return;
        }
        var table = document.createElement('table');
        var thead = document.createElement('thead');
        var headerRow = document.createElement('tr');
        var headers = Object.keys(data[0]);
        for (var h = 0; h < headers.length; h++) {
          var th = document.createElement('th');
          th.textContent = headers[h];
          headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);
        table.appendChild(thead);

        var tbody = document.createElement('tbody');
        for (var r = 0; r < data.length; r++) {
          var row = document.createElement('tr');
          for (var c = 0; c < headers.length; c++) {
            var key = headers[c];
            var normalizedKey = key ? key.toString().toLowerCase() : '';
            var value = data[r][key];
            var td = document.createElement('td');
            if (normalizedKey === 'valor' || normalizedKey === 'comissao' || normalizedKey === 'valorporhora') {
              td.textContent = formatCurrency(value);
            } else if (normalizedKey === 'status') {
              var pill = document.createElement('span');
              var statusValue = (value || '').toString().toLowerCase();
              pill.className = 'status-pill ' + (statusValue === 'ativo' ? 'status-ativo' : 'status-inativo');
              pill.textContent = value || '—';
              td.appendChild(pill);
            } else {
              td.textContent = value !== undefined && value !== null && value !== '' ? value : '—';
            }
            row.appendChild(td);
          }
          tbody.appendChild(row);
        }
        table.appendChild(tbody);
        container.appendChild(table);
      }

      function renderSettings(settings) {
        var container = document.getElementById('settingsGrid');
        container.innerHTML = '';
        if (!settings) {
          return;
        }
        var keys = Object.keys(settings);
        for (var i = 0; i < keys.length; i++) {
          var card = document.createElement('div');
          card.className = 'setting-card';
          var label = document.createElement('span');
          label.textContent = keys[i];
          var value = document.createElement('strong');
          value.textContent = settings[keys[i]];
          card.appendChild(label);
          card.appendChild(value);
          container.appendChild(card);
        }
      }

      function renderIntegrity(warnings) {
        var list = document.getElementById('integrityList');
        list.innerHTML = '';
        if (!warnings || !warnings.length) {
          var li = document.createElement('li');
          li.textContent = 'Nenhum alerta encontrado.';
          list.appendChild(li);
          return;
        }
        for (var i = 0; i < warnings.length; i++) {
          var item = document.createElement('li');
          item.textContent = warnings[i];
          list.appendChild(item);
        }
      }

      function onSuccessCarregarDados(response) {
        loadingEl.style.display = 'none';
        clearError();
        if (!response || !response.success) {
          showError(response && response.message ? response.message : 'Falha ao carregar os dados.');
          return;
        }
        renderKPIs(response.reports && response.reports.kpis ? response.reports.kpis : null);
        renderTable(response.users, 'usersTable');
        renderTable(response.sales, 'salesTable');
        renderTable(response.budgets, 'budgetsTable');
        renderSettings(response.settings);
        var warnings = response.reports && response.reports.integrity ? response.reports.integrity.warnings : [];
        renderIntegrity(warnings);
      }

      function onErrorCarregarDados(error) {
        loadingEl.style.display = 'none';
        showError('Erro inesperado ao carregar painel: ' + error);
      }

      function carregarPainel() {
        loadingEl.style.display = 'flex';
        google.script.run
          .withSuccessHandler(onSuccessCarregarDados)
          .withFailureHandler(onErrorCarregarDados)
          .obterDadosAdmin();
      }

      function atualizarPainel() {
        loadingEl.style.display = 'flex';
        google.script.run
          .withSuccessHandler(function () {
            carregarPainel();
          })
          .withFailureHandler(onErrorCarregarDados)
          .invalidateAllCache();
      }

      for (var i = 0; i < tabButtons.length; i++) {
        tabButtons[i].addEventListener('click', function (event) {
          var target = event.currentTarget.getAttribute('data-target');
          setActiveTab(target);
        });
      }

      document.getElementById('refreshButton').addEventListener('click', function () {
        atualizarPainel();
      });

      window.carregarPainel = carregarPainel;
      window.atualizarPainel = atualizarPainel;

      carregarPainel();
    })();
  </script>
</body>
</html>
