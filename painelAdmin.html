<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Administrativo ‚Äî F/Design Solutions v2.0</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #f7f8fa;
      color: #222;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ========================================= */
    /* SIDEBAR */
    /* ========================================= */
    .sidebar {
      width: 240px;
      background: #ffffff;
      border-right: 1px solid #e6e6e6;
      display: flex;
      flex-direction: column;
      padding: 24px 0;
      z-index: 2;
    }

    .sidebar h2 {
      font-weight: 600;
      font-size: 16px;
      margin: 0 20px 24px;
      color: #111;
    }

    .menu-item {
      padding: 12px 20px;
      cursor: pointer;
      border-left: 3px solid transparent;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: 0.2s;
      color: #333;
      font-weight: 500;
      user-select: none;
    }

    .menu-item:hover {
      background: #f3f4f6;
    }

    .menu-item.active {
      background: #f0f2ff;
      border-left: 3px solid #2b5797;
      color: #2b5797;
      font-weight: 600;
    }

    .logout {
      margin-top: auto;
      padding: 12px 20px;
      background: #fef2f2;
      color: #b91c1c;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      border-top: 1px solid #eee;
      transition: 0.2s;
    }

    .logout:hover {
      background: #fee2e2;
    }

    /* ========================================= */
    /* CONTE√öDO PRINCIPAL */
    /* ========================================= */
    .content {
      flex: 1;
      padding: 32px 48px;
      overflow-y: auto;
      background: #f9fafb;
      position: relative;
      z-index: 1;
    }

    .content-header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 24px;
      color: #111827;
      font-weight: 600;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* ========================================= */
    /* KPIs */
    /* ========================================= */
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .kpi-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .kpi-title {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .kpi-value {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    /* ========================================= */
    /* TABELAS COM ACCORDION */
    /* ========================================= */
    .data-table {
      width: 100%;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      margin-bottom: 24px;
    }

    .data-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      padding: 12px 16px;
      background: #f0f2ff;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      color: #374151;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 14px;
    }

    .data-table tbody tr.main-row {
      cursor: pointer;
      transition: background 0.2s;
    }

    .data-table tbody tr.main-row:hover {
      background: #f9fafb;
    }

    .data-table tbody tr.main-row.expanded {
      background: #f0f2ff;
    }

    /* Linha de detalhes (accordion) */
    .details-row {
      display: none;
      background: #fafbfc;
    }

    .details-row.show {
      display: table-row;
    }

    .details-row td {
      padding: 0;
      border-bottom: 2px solid #e5e7eb;
    }

    .details-content {
      padding: 24px;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ========================================= */
    /* CARDS DE DETALHES */
    /* ========================================= */
    .detail-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .detail-header {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f2ff;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .detail-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-value {
      font-size: 14px;
      color: #111827;
      font-weight: 500;
    }

    /* ========================================= */
    /* BADGES E INDICADORES */
    /* ========================================= */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-ativo {
      background: #d1fae5;
      color: #065f46;
    }

    .status-inativo {
      background: #fee2e2;
      color: #991b1b;
    }

    .indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .indicator-green {
      background: #10b981;
    }

    .indicator-yellow {
      background: #f59e0b;
    }

    .indicator-burgundy {
      background: #991b1b;
    }

    .indicator-gray {
      background: #9ca3af;
    }

    /* ========================================= */
    /* M√âTRICAS VISUAIS */
    /* ========================================= */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .metric-box {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      text-align: center;
    }

    .metric-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
    }

    .metric-value.good {
      color: #059669;
    }

    .metric-value.warning {
      color: #d97706;
    }

    .metric-value.critical {
      color: #dc2626;
    }

    /* ========================================= */
    /* BOT√ïES DE A√á√ÉO */
    /* ========================================= */
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-edit {
      background: #eff6ff;
      color: #1e40af;
    }

    .btn-edit:hover {
      background: #dbeafe;
    }

    .btn-remove {
      background: #fef2f2;
      color: #b91c1c;
    }

    .btn-remove:hover {
      background: #fee2e2;
    }

    .btn-deactivate {
      background: #fef3c7;
      color: #92400e;
    }

    .btn-deactivate:hover {
      background: #fde68a;
    }

    .btn-add {
      background: #2b5797;
      color: #ffffff;
      padding: 10px 20px;
      margin-bottom: 16px;
    }

    .btn-add:hover {
      background: #1e3a5f;
    }

    .btn-refresh {
      background: #1f2937;
      color: #ffffff;
      padding: 10px 18px;
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
    }

    .btn-refresh:hover:not(:disabled) {
      background: #111827;
    }

    /* ========================================= */
    /* √çCONE DE EXPANS√ÉO */
    /* ========================================= */
    .expand-icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      text-align: center;
      line-height: 20px;
      transition: transform 0.3s;
      color: #6b7280;
    }

    .expand-icon.expanded {
      transform: rotate(90deg);
    }

    /* ========================================= */
    /* GR√ÅFICOS */
    /* ========================================= */
    .chart-container {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .chart-container h3 {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 16px;
    }

    /* ========================================= */
    /* UTILIT√ÅRIOS */
    /* ========================================= */
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
      font-size: 16px;
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 16px;
      border-radius: 8px;
      margin: 20px 0;
      font-weight: 500;
    }

    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 500;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      animation: fadeSlide 3s ease forwards;
      z-index: 1000;
    }

    @keyframes fadeSlide {
      0% {opacity: 0; transform: translateY(-10px);}
      10% {opacity: 1; transform: translateY(0);}
      90% {opacity: 1;}
      100% {opacity: 0; transform: translateY(-10px);}
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* ========================================= */
    /* SCROLLBAR CUSTOMIZADA */
    /* ========================================= */
    .content::-webkit-scrollbar {
      width: 8px;
    }

    .content::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .content::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    .content::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
  </style>
</head>
<body>
  <!-- ====================================== -->
  <!-- SIDEBAR LATERAL -->
  <!-- ====================================== -->
  <aside class="sidebar">
    <h2>F/Design Admin v2.0</h2>
    <div class="menu-item active" onclick="showSection('reports', this)">üìä Reports</div>
    <div class="menu-item" onclick="showSection('users', this)">üë• Users</div>
    <div class="menu-item" onclick="showSection('budgets', this)">üíº Budgets</div>
    <div class="menu-item" onclick="showSection('sales', this)">üí∞ Sales</div>
    <div class="menu-item" onclick="showSection('settings', this)">‚öôÔ∏è Settings</div>
    <div class="logout" onclick="encerrarSessao()">Sair</div>
  </aside>

  <!-- ====================================== -->
  <!-- CONTE√öDO PRINCIPAL -->
  <!-- ====================================== -->
  <main class="content">
    <div class="content-header">
      <!-- Bot√£o manual para atualiza√ß√£o pontual dos dados -->
      <button id="refreshDataButton" class="btn btn-refresh" type="button">üîÑ Atualizar Dados</button>
    </div>

    <!-- ===================== -->
    <!-- SECTION 1: REPORTS -->
    <!-- ===================== -->
    <section id="reports" class="section active">
      <h1>üìä Reports & Analytics</h1>
      <div id="reportsLoading" class="loading" data-default-message="Carregando relat√≥rios...">Carregando relat√≥rios...</div>
      <div id="reportsContent" style="display:none;">
        <div class="kpi-container">
          <div class="kpi-card">
            <div class="kpi-title">Total de Vendas</div>
            <div id="kpi-totalVendas" class="kpi-value">$0.00</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-title">Comiss√µes Pagas</div>
            <div id="kpi-totalComissoes" class="kpi-value">$0.00</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-title">Or√ßamentos Abertos</div>
            <div id="kpi-orcamentosAbertos" class="kpi-value">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-title">Vendedores Ativos</div>
            <div id="kpi-vendedoresAtivos" class="kpi-value">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-title">Taxa de Convers√£o</div>
            <div id="kpi-taxaConversao" class="kpi-value">0%</div>
          </div>
        </div>

        <div class="chart-container">
          <h3>Vendas por Tipo</h3>
          <div id="chartVendasPorTipo" style="height:300px;"></div>
        </div>

        <div class="chart-container">
          <h3>Or√ßamentos por Status</h3>
          <div id="chartOrcPorStatus" style="height:300px;"></div>
        </div>
      </div>
    </section>

    <!-- ===================== -->
    <!-- SECTION 2: USERS -->
    <!-- ===================== -->
    <section id="users" class="section">
      <h1>üë• Users Management</h1>
      <button class="btn btn-add" onclick="addNewUser()">‚ûï Add New Employee</button>
      <div id="usersLoading" class="loading" data-default-message="Carregando usu√°rios...">Carregando usu√°rios...</div>
      <div id="usersContent" style="display:none;">
        <div class="data-table">
          <table>
            <thead>
              <tr>
                <th style="width:30px;"></th>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Status</th>
                <th>Total Vendas</th>
                <th>Taxa Convers√£o</th>
                <th>Comiss√£o</th>
              </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===================== -->
    <!-- SECTION 3: BUDGETS -->
    <!-- ===================== -->
    <section id="budgets" class="section">
      <h1>üíº Budgets & Quotes</h1>
      <div id="budgetsLoading" class="loading" data-default-message="Carregando or√ßamentos...">Carregando or√ßamentos...</div>
      <div id="budgetsContent" style="display:none;">
        <div class="data-table">
          <table>
            <thead>
              <tr>
                <th style="width:30px;"></th>
                <th>Data</th>
                <th>Tipo</th>
                <th>Cliente</th>
                <th>Valor</th>
                <th>Status</th>
                <th>Respons√°vel</th>
              </tr>
            </thead>
            <tbody id="budgetsTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===================== -->
    <!-- SECTION 4: SALES -->
    <!-- ===================== -->
    <section id="sales" class="section">
      <h1>üí∞ Sales History</h1>
      <div id="salesLoading" class="loading" data-default-message="Carregando vendas...">Carregando vendas...</div>
      <div id="salesContent" style="display:none;">
        <div class="data-table">
          <table>
            <thead>
              <tr>
                <th style="width:30px;"></th>
                <th>Data</th>
                <th>Tipo</th>
                <th>Cliente</th>
                <th>Valor</th>
                <th>Comiss√£o</th>
                <th>Vendedor</th>
              </tr>
            </thead>
            <tbody id="salesTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===================== -->
    <!-- SECTION 5: SETTINGS -->
    <!-- ===================== -->
    <section id="settings" class="section">
      <h1>‚öôÔ∏è System Settings</h1>
      <div id="settingsLoading" class="loading" data-default-message="Carregando configura√ß√µes...">Carregando configura√ß√µes...</div>
      <div id="settingsContent" style="display:none;">
        <div class="detail-card">
          <div class="detail-header">Configura√ß√µes do Sistema</div>
          <div id="settingsGrid" class="detail-grid"></div>
        </div>
      </div>
    </section>

  </main>
  
  <!-- ========================================= -->
  <!-- JAVASCRIPT PRINCIPAL -->
  <!-- ========================================= -->
  <script>
    // =========================================
    // VARI√ÅVEIS GLOBAIS
    // =========================================
    let adminData = null;
    let refreshButton = null;
    // Mapeia os elementos de loading/conte√∫do para alternar entre estados de carregamento e erro
    const sectionLoadingMap = [
      { loadingId: 'reportsLoading', contentId: 'reportsContent' },
      { loadingId: 'usersLoading', contentId: 'usersContent' },
      { loadingId: 'budgetsLoading', contentId: 'budgetsContent' },
      { loadingId: 'salesLoading', contentId: 'salesContent' },
      { loadingId: 'settingsLoading', contentId: 'settingsContent' }
    ];

    // Reativa o placeholder padr√£o durante requisi√ß√µes e oculta conte√∫dos desatualizados
    function setLoadingState(isLoading) {
      sectionLoadingMap.forEach(({ loadingId, contentId }) => {
        const loadingEl = document.getElementById(loadingId);
        const contentEl = document.getElementById(contentId);

        if (isLoading) {
          if (loadingEl) {
            const defaultMessage = loadingEl.getAttribute('data-default-message');
            if (defaultMessage) {
              loadingEl.textContent = defaultMessage;
            }
            loadingEl.style.display = 'block';
          }
          if (contentEl) {
            contentEl.style.display = 'none';
          }
        } else if (loadingEl) {
          loadingEl.style.display = 'none';
        }
      });
    }

    // Evita m√∫ltiplas chamadas concorrentes desabilitando o bot√£o durante o carregamento
    function toggleRefreshButton(isLoading) {
      if (!refreshButton) return;
      if (isLoading) {
        if (!refreshButton.dataset.originalText) {
          refreshButton.dataset.originalText = refreshButton.textContent;
        }
        refreshButton.disabled = true;
        refreshButton.textContent = '‚è≥ Atualizando...';
      } else {
        refreshButton.disabled = false;
        const originalText = refreshButton.dataset.originalText || 'üîÑ Atualizar Dados';
        refreshButton.textContent = originalText;
      }
    }

    function finalizarCarregamento() {
      toggleRefreshButton(false);
    }

    // =========================================
    // INICIALIZA√á√ÉO
    // =========================================
    window.addEventListener('DOMContentLoaded', function () {
      console.log('üöÄ Painel Administrativo v2.0 iniciado...');
      google.charts.load('current', { packages: ['corechart'] });
      refreshButton = document.getElementById('refreshDataButton');
      if (refreshButton) {
        // Atualiza√ß√£o agora depende de a√ß√£o manual do administrador
        refreshButton.addEventListener('click', () => {
          carregarDadosAdmin();
        });
      }
      carregarDadosAdmin();
    });

    // =========================================
    // FUN√á√ÉO PRINCIPAL: CARREGAR DADOS
    // =========================================
    function carregarDadosAdmin() {
      setLoadingState(true);
      toggleRefreshButton(true);
      google.script.run
        .withSuccessHandler(onSuccessCarregarDados)
        .withFailureHandler(onErrorCarregarDados)
        .obterDadosAdmin();
    }

    function onSuccessCarregarDados(response) {
      console.log('‚úÖ Dados recebidos:', response);
      if (!response || !response.success) {
        finalizarCarregamento();
        showError('Erro ao carregar dados: ' + (response?.message || 'Falha desconhecida.'));
        return;
      }

      setLoadingState(false);
      const data = response.data || {};
      adminData = {
        reports: data.reports || {},
        users: Array.isArray(data.users) ? data.users : [],
        budgets: Array.isArray(data.budgets) ? data.budgets : [],
        sales: Array.isArray(data.sales) ? data.sales : [],
        settings: data.settings || {}
      };

      try {
        renderReports(adminData.reports);
        renderUsers(adminData.users);
        renderBudgets(adminData.budgets);
        renderSales(adminData.sales);
        renderSettings(adminData.settings);
        showAlert('‚úÖ Dados carregados com sucesso!');
      } catch (renderError) {
        console.error('‚ö†Ô∏è Falha ao renderizar o painel:', renderError);
        showError('Erro ao exibir os dados no painel. Verifique os logs.');
      } finally {
        finalizarCarregamento();
      }
    }

    function onErrorCarregarDados(error) {
      console.error('‚ùå Erro ao carregar dados:', error);
      finalizarCarregamento();
      showError('Erro de conex√£o: ' + (error?.message || 'Erro desconhecido.'));
    }

    // =========================================
    // üìä RENDERIZA√á√ÉO: REPORTS
    // =========================================
    function renderReports(reports) {
      const loadingEl = document.getElementById('reportsLoading');
      const contentEl = document.getElementById('reportsContent');
      if (loadingEl) loadingEl.style.display = 'none';
      if (contentEl) contentEl.style.display = 'block';

      const safeReports = reports || {}; // Prote√ß√£o contra retornos parciais do backend
      const kpis = safeReports.kpis || {};

      const totalVendas = Number(kpis.totalVendas || 0);
      const totalComissoes = Number(kpis.totalComissoes || 0);
      const orcamentosAbertos = Number(kpis.orcamentosAbertos || 0);
      const vendedoresAtivos = Number(kpis.vendedoresAtivos || 0);
      const taxaConversao = Number(kpis.taxaConversao || 0);

      document.getElementById('kpi-totalVendas').textContent = '$' + totalVendas.toFixed(2);
      document.getElementById('kpi-totalComissoes').textContent = '$' + totalComissoes.toFixed(2);
      document.getElementById('kpi-orcamentosAbertos').textContent = orcamentosAbertos.toString();
      document.getElementById('kpi-vendedoresAtivos').textContent = vendedoresAtivos.toString();
      document.getElementById('kpi-taxaConversao').textContent = taxaConversao.toFixed(1) + '%';

      const chartVendasContainer = document.getElementById('chartVendasPorTipo');
      const chartOrcContainer = document.getElementById('chartOrcPorStatus');

      const grafVendas = Array.isArray(safeReports.grafVendasPorTipo) ? safeReports.grafVendasPorTipo : [];
      const grafOrc = Array.isArray(safeReports.grafOrcPorStatus) ? safeReports.grafOrcPorStatus : [];

      google.charts.setOnLoadCallback(function () {
        try {
          if (grafVendas.length > 1 && chartVendasContainer) {
            const dataVendas = google.visualization.arrayToDataTable(grafVendas);
            const chartVendas = new google.visualization.PieChart(chartVendasContainer);
            chartVendas.draw(dataVendas, {
              title: '',
              pieHole: 0.4,
              colors: ['#2b5797', '#fbbc04', '#34a853'],
              legend: { position: 'bottom' },
            });
          } else if (chartVendasContainer) {
            chartVendasContainer.innerHTML = '<p style="text-align:center;color:#6b7280;">Sem dados suficientes</p>';
          }

          if (grafOrc.length > 1 && chartOrcContainer) {
            const dataOrc = google.visualization.arrayToDataTable(grafOrc);
            const chartOrc = new google.visualization.PieChart(chartOrcContainer);
            chartOrc.draw(dataOrc, {
              title: '',
              pieHole: 0.4,
              colors: ['#2b5797', '#fbbc04', '#ea4335'],
              legend: { position: 'bottom' },
            });
          } else if (chartOrcContainer) {
            chartOrcContainer.innerHTML = '<p style="text-align:center;color:#6b7280;">Sem dados suficientes</p>';
          }
        } catch (err) {
          console.warn('‚ö†Ô∏è Erro ao desenhar gr√°ficos:', err);
        }
      });
    }

    // =========================================
    // üë• RENDERIZA√á√ÉO: USERS (COM ACCORDION)
    // =========================================
    function renderUsers(users) {
      document.getElementById('usersLoading').style.display = 'none';
      document.getElementById('usersContent').style.display = 'block';
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';

      const listaUsuarios = Array.isArray(users) ? users : []; // Evita TypeError quando o backend n√£o envia a lista

      if (listaUsuarios.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üì≠</div><div>Nenhum usu√°rio cadastrado</div></td></tr>';
        return;
      }

      listaUsuarios.forEach((user, index) => {
        const statusClass = user.status === 'Ativo' ? 'status-ativo' : 'status-inativo';
        const metrics = user.metrics || {};
        const financial = metrics.financial || {};
        const conversion = metrics.conversion || {};
        const comissaoPadrao = Number(user.comissao || 0);

        // Linha principal
        const mainRow = `
          <tr class="main-row" onclick="toggleUserDetails(${index})">
            <td><span class="expand-icon" id="expand-user-${index}">‚ñ∂</span></td>
            <td><strong>${user.nome}</strong></td>
            <td>${user.tipo}</td>
            <td><span class="status-badge ${statusClass}">${user.status}</span></td>
            <td>$${financial.totalRevenue ? financial.totalRevenue.toFixed(2) : '0.00'}</td>
            <td>${conversion.rate ? conversion.rate.toFixed(1) : '0'}%</td>
            <td>${(comissaoPadrao * 100).toFixed(0)}%</td>
          </tr>
        `;
        
        // Linha de detalhes (accordion)
        const detailsRow = `
          <tr class="details-row" id="details-user-${index}">
            <td colspan="7">
              <div class="details-content">
                ${renderUserDetails(user)}
              </div>
            </td>
          </tr>
        `;
        
        tbody.innerHTML += mainRow + detailsRow;
      });
    }

    function renderUserDetails(user) {
      const m = user.metrics || {};
      const comm = m.communication || {};
      const eff = m.effectiveness || {};
      const conv = m.conversion || {};
      const fin = m.financial || {};
      const der = m.derived || {};
      const comissaoPadrao = Number(user.comissao || 0);
      
      return `
        <div class="detail-card">
          <div class="detail-header">üìä An√°lise Completa: ${user.nome}</div>
          
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">ID</div>
              <div class="detail-value">${user.id}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Email</div>
              <div class="detail-value">${user.email || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Telefone</div>
              <div class="detail-value">${user.telefone || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Comiss√£o Padr√£o</div>
              <div class="detail-value">${(comissaoPadrao * 100).toFixed(0)}%</div>
            </div>
          </div>

          <div class="detail-header" style="margin-top:24px;">üí¨ Comunica√ß√£o</div>
          <div class="metrics-grid">
            <div class="metric-box">
              <div class="metric-label">Mensagens</div>
              <div class="metric-value">${comm.messages || 0}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Liga√ß√µes</div>
              <div class="metric-value">${comm.calls || 0}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Total Contatos</div>
              <div class="metric-value">${comm.total || 0}</div>
            </div>
          </div>

          <div class="detail-header" style="margin-top:24px;">‚úÖ Efetividade</div>
          <div class="metrics-grid">
            <div class="metric-box">
              <div class="metric-label">Resp. Positivas</div>
              <div class="metric-value good">${eff.respPos || 0}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Resp. Negativas</div>
              <div class="metric-value critical">${eff.respNeg || 0}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">PRR (%)</div>
              <div class="metric-value ${eff.prr > 70 ? 'good' : eff.prr > 40 ? 'warning' : 'critical'}">${eff.prr ? eff.prr.toFixed(1) : '0'}%</div>
            </div>
          </div>

          <div class="detail-header" style="margin-top:24px;">üéØ Convers√£o</div>
          <div class="metrics-grid">
            <div class="metric-box">
              <div class="metric-label">Or√ßamentos</div>
              <div class="metric-value">${conv.totalBudgets || 0}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Convertidos</div>
              <div class="metric-value good">${conv.converted || 0}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Taxa (%)</div>
              <div class="metric-value ${conv.rate > 30 ? 'good' : conv.rate > 15 ? 'warning' : 'critical'}">${conv.rate ? conv.rate.toFixed(1) : '0'}%</div>
            </div>
          </div>

          <div class="detail-header" style="margin-top:24px;">üí∞ Financeiro</div>
          <div class="metrics-grid">
            <div class="metric-box">
              <div class="metric-label">Receita Total</div>
              <div class="metric-value good">$${fin.totalRevenue ? fin.totalRevenue.toFixed(2) : '0.00'}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Comiss√£o Total</div>
              <div class="metric-value">$${fin.totalCommission ? fin.totalCommission.toFixed(2) : '0.00'}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Valor M√©dio</div>
              <div class="metric-value">$${fin.avgSaleValue ? fin.avgSaleValue.toFixed(2) : '0.00'}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Lucro/Hora</div>
              <div class="metric-value">$${fin.profitabilityPerHour ? fin.profitabilityPerHour.toFixed(2) : '0.00'}</div>
            </div>
          </div>

          <div class="detail-header" style="margin-top:24px;">üìà M√©tricas Derivadas</div>
          <div class="metrics-grid">
            <div class="metric-box">
              <div class="metric-label">OEI</div>
              <div class="metric-value ${der.oei > 5 ? 'good' : der.oei > 2 ? 'warning' : 'critical'}">${der.oei ? der.oei.toFixed(2) : '0.00'}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">CE (%)</div>
              <div class="metric-value ${der.ce > 30 ? 'good' : der.ce > 15 ? 'warning' : 'critical'}">${der.ce ? der.ce.toFixed(1) : '0'}%</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">HP ($/h)</div>
              <div class="metric-value">$${der.hp ? der.hp.toFixed(2) : '0.00'}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">NEP</div>
              <div class="metric-value good">$${der.nep ? parseFloat(der.nep).toFixed(2) : '0.00'}</div>
            </div>
          </div>

          <div class="action-buttons">
            <button class="btn btn-edit" onclick="editUser('${user.id}')">‚úèÔ∏è Editar</button>
            <button class="btn btn-deactivate" onclick="deactivateUser('${user.id}')">‚õî Desativar</button>
            <button class="btn btn-remove" onclick="removeUser('${user.id}')">‚ùå Remover</button>
          </div>
        </div>
      `;
    }

    function toggleUserDetails(index) {
      const detailsRow = document.getElementById(`details-user-${index}`);
      const expandIcon = document.getElementById(`expand-user-${index}`);
      const mainRow = detailsRow.previousElementSibling;
      
      if (detailsRow.classList.contains('show')) {
        detailsRow.classList.remove('show');
        expandIcon.classList.remove('expanded');
        mainRow.classList.remove('expanded');
      } else {
        detailsRow.classList.add('show');
        expandIcon.classList.add('expanded');
        mainRow.classList.add('expanded');
      }
    }

    // =========================================
    // üíº RENDERIZA√á√ÉO: BUDGETS (COM ACCORDION)
    // =========================================
    function renderBudgets(budgets) {
      document.getElementById('budgetsLoading').style.display = 'none';
      document.getElementById('budgetsContent').style.display = 'block';
      const tbody = document.getElementById('budgetsTableBody');
      tbody.innerHTML = '';

      const listaOrcamentos = Array.isArray(budgets) ? budgets : []; // Protege contra respostas sem dados de or√ßamento

      if (listaOrcamentos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üì≠</div><div>Nenhum or√ßamento cadastrado</div></td></tr>';
        return;
      }

      listaOrcamentos.forEach((budget, index) => {
        const indicatorClass = `indicator-${budget.corStatus || 'gray'}`;
        
        const mainRow = `
          <tr class="main-row" onclick="toggleBudgetDetails(${index})">
            <td><span class="expand-icon" id="expand-budget-${index}">‚ñ∂</span></td>
            <td><span class="indicator ${indicatorClass}"></span>${budget.dataCriacao}</td>
            <td>${budget.origem}</td>
            <td>${budget.cliente}</td>
            <td>$${budget.valor.toFixed(2)}</td>
            <td>${budget.status}</td>
            <td>${budget.criadoPor}</td>
          </tr>
        `;
        
        const detailsRow = `
          <tr class="details-row" id="details-budget-${index}">
            <td colspan="7">
              <div class="details-content">
                ${renderBudgetDetails(budget)}
              </div>
            </td>
          </tr>
        `;
        
        tbody.innerHTML += mainRow + detailsRow;
      });
    }

    function renderBudgetDetails(budget) {
      const diasText = budget.diasDecorridos !== null ? `${budget.diasDecorridos} dias` : '-';
      const probConv = budget.probabilidadeConversao || 0;
      
      return `
        <div class="detail-card">
          <div class="detail-header">üíº Detalhes do Or√ßamento: ${budget.id}</div>
          
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Data Cria√ß√£o</div>
              <div class="detail-value">${budget.dataCriacao}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Dias Decorridos</div>
              <div class="detail-value">${diasText}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Origem</div>
              <div class="detail-value">${budget.origem}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Criado Por</div>
              <div class="detail-value">${budget.criadoPor}</div>
            </div>
          </div>

          <div class="detail-header" style="margin-top:24px;">üë§ Informa√ß√µes do Cliente</div>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Nome</div>
              <div class="detail-value">${budget.cliente}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Email</div>
              <div class="detail-value">${budget.email || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Telefone</div>
              <div class="detail-value">${budget.telefone || '-'}</div>
            </div>
          </div>

          <div class="detail-header" style="margin-top:24px;">üìã Detalhes do Projeto</div>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Descri√ß√£o</div>
              <div class="detail-value">${budget.descricao || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Valor Estimado</div>
              <div class="detail-value">$${budget.valor.toFixed(2)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Status</div>
              <div class="detail-value">${budget.status}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">√öltimo Contato</div>
              <div class="detail-value">${budget.ultimoContato || '-'}</div>
            </div>
          </div>

          <div class="detail-header" style="margin-top:24px;">üìû Hist√≥rico de Comunica√ß√£o</div>
          <div class="metrics-grid">
            <div class="metric-box">
              <div class="metric-label">Mensagens</div>
              <div class="metric-value">${budget.mensagens || 0}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Liga√ß√µes</div>
              <div class="metric-value">${budget.ligacoes || 0}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Resp. Positivas</div>
              <div class="metric-value good">${budget.respPos || 0}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Resp. Negativas</div>
              <div class="metric-value critical">${budget.respNeg || 0}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Prob. Convers√£o</div>
              <div class="metric-value ${probConv > 70 ? 'good' : probConv > 40 ? 'warning' : 'critical'}">${probConv}%</div>
            </div>
          </div>

          ${budget.motivoPerda ? `
          <div class="detail-header" style="margin-top:24px;">‚ùå Motivo da Perda</div>
          <div class="detail-value" style="padding:12px;background:#fef2f2;border-radius:6px;color:#991b1b;">${budget.motivoPerda}</div>
          ` : ''}

          ${budget.obs ? `
          <div class="detail-header" style="margin-top:24px;">üìù Observa√ß√µes</div>
          <div class="detail-value" style="padding:12px;background:#f9fafb;border-radius:6px;">${budget.obs}</div>
          ` : ''}
        </div>
      `;
    }

    function toggleBudgetDetails(index) {
      const detailsRow = document.getElementById(`details-budget-${index}`);
      const expandIcon = document.getElementById(`expand-budget-${index}`);
      const mainRow = detailsRow.previousElementSibling;
      
      if (detailsRow.classList.contains('show')) {
        detailsRow.classList.remove('show');
        expandIcon.classList.remove('expanded');
        mainRow.classList.remove('expanded');
      } else {
        detailsRow.classList.add('show');
        expandIcon.classList.add('expanded');
        mainRow.classList.add('expanded');
      }
    }

    // =========================================
    // üí∞ RENDERIZA√á√ÉO: SALES (COM ACCORDION)
    // =========================================
    function renderSales(sales) {
      document.getElementById('salesLoading').style.display = 'none';
      document.getElementById('salesContent').style.display = 'block';
      const tbody = document.getElementById('salesTableBody');
      tbody.innerHTML = '';

      const listaVendas = Array.isArray(sales) ? sales : []; // Evita quebra quando vendas n√£o s√£o carregadas

      if (listaVendas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üì≠</div><div>Nenhuma venda registrada</div></td></tr>';
        return;
      }

      listaVendas.forEach((sale, index) => {
        const mainRow = `
          <tr class="main-row" onclick="toggleSaleDetails(${index})">
            <td><span class="expand-icon" id="expand-sale-${index}">‚ñ∂</span></td>
            <td>${sale.data}</td>
            <td>${sale.tipo}</td>
            <td>${sale.cliente}</td>
            <td>$${sale.valor.toFixed(2)}</td>
            <td>$${sale.comissao.toFixed(2)}</td>
            <td>${sale.vendedorId || '-'}</td>
          </tr>
        `;
        
        const detailsRow = `
          <tr class="details-row" id="details-sale-${index}">
            <td colspan="7">
              <div class="details-content">
                ${renderSaleDetails(sale)}
              </div>
            </td>
          </tr>
        `;
        
        tbody.innerHTML += mainRow + detailsRow;
      });
    }

    function renderSaleDetails(sale) {
      return `
        <div class="detail-card">
          <div class="detail-header">üí∞ Detalhes da Venda</div>
          
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Data</div>
              <div class="detail-value">${sale.data}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Tipo</div>
              <div class="detail-value">${sale.tipo}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Cliente</div>
              <div class="detail-value">${sale.cliente}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Empresa</div>
              <div class="detail-value">${sale.empresa || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Invoice</div>
              <div class="detail-value">${sale.invoice}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Produto</div>
              <div class="detail-value">${sale.produto || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Criado Por</div>
              <div class="detail-value">${sale.criadoPor || '-'}</div>
            </div>
          </div>

          <div class="detail-header" style="margin-top:24px;">üíµ Informa√ß√µes Financeiras</div>
          <div class="metrics-grid">
            <div class="metric-box">
              <div class="metric-label">Valor Total</div>
              <div class="metric-value good">$${sale.valor.toFixed(2)}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Comiss√£o</div>
              <div class="metric-value">$${sale.comissao.toFixed(2)}</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Vendedor</div>
              <div class="metric-value">${sale.vendedorId || '-'}</div>
            </div>
            ${sale.tentativasContato ? `
            <div class="metric-box">
              <div class="metric-label">Tentativas</div>
              <div class="metric-value">${sale.tentativasContato}</div>
            </div>
            ` : ''}
            ${sale.valorPorHora ? `
            <div class="metric-box">
              <div class="metric-label">Valor/Hora</div>
              <div class="metric-value">$${sale.valorPorHora.toFixed(2)}</div>
            </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function toggleSaleDetails(index) {
      const detailsRow = document.getElementById(`details-sale-${index}`);
      const expandIcon = document.getElementById(`expand-sale-${index}`);
      const mainRow = detailsRow.previousElementSibling;
      
      if (detailsRow.classList.contains('show')) {
        detailsRow.classList.remove('show');
        expandIcon.classList.remove('expanded');
        mainRow.classList.remove('expanded');
      } else {
        detailsRow.classList.add('show');
        expandIcon.classList.add('expanded');
        mainRow.classList.add('expanded');
      }
    }

    // =========================================
    // ‚öôÔ∏è RENDERIZA√á√ÉO: SETTINGS
    // =========================================
    function renderSettings(settings) {
      document.getElementById('settingsLoading').style.display = 'none';
      document.getElementById('settingsContent').style.display = 'block';
      const grid = document.getElementById('settingsGrid');
      grid.innerHTML = '';

      const safeSettings = (settings && typeof settings === 'object') ? settings : {}; // Garante objeto iter√°vel

      if (Object.keys(safeSettings).length === 0) {
        grid.innerHTML = '<p style="color:#6b7280;">Nenhuma configura√ß√£o dispon√≠vel</p>';
        return;
      }

      Object.entries(safeSettings).forEach(([key, value]) => {
        const item = `
          <div class="detail-item">
            <div class="detail-label">${key}</div>
            <div class="detail-value">${value}</div>
          </div>
        `;
        grid.innerHTML += item;
      });
    }

    // =========================================
    // üß≠ TROCAR SE√á√ïES
    // =========================================
    function showSection(id, el) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');

      document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
      el.classList.add('active');
    }

    // =========================================
    // ‚öôÔ∏è A√á√ïES DE USU√ÅRIO
    // =========================================
    function addNewUser() {
      showAlert('üöß Funcionalidade em desenvolvimento');
    }

    function editUser(userId) {
      showAlert('‚úèÔ∏è Editar usu√°rio: ' + userId);
    }

    function deactivateUser(userId) {
      if (confirm('Deseja realmente desativar este usu√°rio?')) {
        showAlert('‚õî Usu√°rio desativado: ' + userId);
      }
    }

    function removeUser(userId) {
      if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o √© irrevers√≠vel. Deseja realmente remover este usu√°rio?')) {
        showAlert('‚ùå Usu√°rio removido: ' + userId);
      }
    }

    // =========================================
    // ‚öôÔ∏è UTILIT√ÅRIOS
    // =========================================
    function showAlert(msg) {
      const div = document.createElement('div');
      div.className = 'alert';
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    function showError(msg) {
      const sections = ['reports', 'users', 'budgets', 'sales', 'settings'];
      sections.forEach(section => {
        const loading = document.getElementById(section + 'Loading');
        const content = document.getElementById(section + 'Content');
        if (content) {
          content.style.display = 'none';
        }
        if (loading) {
          loading.style.display = 'block';
          loading.innerHTML = `<div class="error-message">‚ùå ${msg}</div>`;
        }
      });
    }

    function encerrarSessao() {
      if (confirm('Deseja realmente sair do painel administrativo?')) {
        google.script.run.encerrarSessao();
        google.script.host.close();
      }
    }
  </script>
</body>
</html>
