<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Vendas ‚Äî F/Design Solutions</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #fbbc04 0%, #2b5797 100%);
      min-height: 100vh;
      color: #fff;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 140px;
      height: auto;
    }

    .company-info h1 {
      font-size: 20px;
      font-weight: 600;
      color: #2b5797;
      margin-bottom: 2px;
    }

    .company-info p {
      font-size: 14px;
      color: #6b7280;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .export-btn {
      background: linear-gradient(135deg, #fbbc04, #e0a800);
      color: #000;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.2s;
    }

    .export-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(251, 188, 4, 0.3);
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.9);
      color: #374151;
      border: 1px solid #d1d5db;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .back-btn:hover {
      background: white;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }

    .welcome-section {
      text-align: center;
      margin-bottom: 30px;
    }

    .welcome-section h2 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .welcome-section p {
      opacity: 0.9;
      font-size: 16px;
    }

    .filters-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      align-items: end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-label {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    .filter-input,
    .filter-select {
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    .filter-input:focus,
    .filter-select:focus {
      outline: none;
      border-color: #2b5797;
      box-shadow: 0 0 0 3px rgba(43, 87, 151, 0.1);
    }

    .filter-btn {
      background: linear-gradient(135deg, #2b5797, #1e40af);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.2s;
    }

    .filter-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(43, 87, 151, 0.3);
    }

    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(360deg); }
    }

    .metrics-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-5px);
    }

    .metric-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 15px;
    }

    .metric-title {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 28px;
      font-weight: 700;
      color: #2b5797;
      margin-bottom: 5px;
    }

    .metric-subtitle {
      font-size: 14px;
      color: #6b7280;
    }

    .charts-section {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 20px;
      text-align: center;
    }

    .full-chart {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 30px;
    }

    .message {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      text-align: center;
    }

    .message.success {
      background: rgba(16, 185, 129, 0.9);
      color: white;
    }

    .message.error {
      background: rgba(239, 68, 68, 0.9);
      color: white;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 16px;
    }

    @media (max-width: 1024px) {
      .charts-section {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .filters-grid {
        grid-template-columns: 1fr;
      }

      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .container {
        padding: 20px;
      }

      .welcome-section h2 {
        font-size: 24px;
      }

      .metrics-section {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="logo-section">
      <img src="https://fdesignsolutions.com/wp-content/uploads/2023/08/logo-F-design-branca-768x231.webp"
           alt="F/Design Solutions"
           class="logo">
      <div class="company-info">
        <h1>F/Design Solutions</h1>
        <p>Dashboard de Vendas</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="export-btn" onclick="exportarRelatorio()" id="exportBtn">
        üì§ Export PDF
      </button>
      <button class="back-btn" onclick="voltarMenu()">
        ‚Üê Voltar
      </button>
    </div>
  </header>

  <div class="container">
    <div class="welcome-section">
      <h2>üìä Dashboard de Vendas</h2>
      <p>An√°lise detalhada do desempenho de vendas</p>
    </div>

    <div id="successMessage" class="message success"></div>
    <div id="errorMessage" class="message error"></div>

    <!-- Filtros -->
    <div class="filters-section">
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">Per√≠odo</label>
          <select class="filter-select" id="filtroPeriodo">
            <option value="mes">M√™s Atual</option>
            <option value="ano">Ano Atual</option>
            <option value="todos">Todos os Dados</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Data Inicial</label>
          <input type="date" class="filter-input" id="dataInicio">
        </div>

        <div class="filter-group">
          <label class="filter-label">Data Final</label>
          <input type="date" class="filter-input" id="dataFim">
        </div>

        <button class="filter-btn" onclick="atualizarDashboard()" id="atualizarBtn">
          <span id="btnIcon">‚ö°</span>
          <span id="btnText">Atualizar Dados</span>
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="loading" style="display: none;">
      Carregando dados do dashboard...
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" style="display: none;">
      <!-- M√©tricas -->
      <div class="metrics-section">
        <div class="metric-card">
          <div class="metric-icon" style="background: linear-gradient(135deg, #10b981, #059669);">üí∞</div>
          <div class="metric-title">Total de Vendas</div>
          <div class="metric-value" id="totalVendas">$0.00</div>
          <div class="metric-subtitle">Valor total das vendas</div>
        </div>

        <div class="metric-card">
          <div class="metric-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">üìà</div>
          <div class="metric-title">Total de Comiss√µes</div>
          <div class="metric-value" id="totalComissoes">$0.00</div>
          <div class="metric-subtitle">Comiss√µes pagas</div>
        </div>

        <div class="metric-card">
          <div class="metric-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">üéØ</div>
          <div class="metric-title">Vendas New</div>
          <div class="metric-value" id="vendasNew">0</div>
          <div class="metric-subtitle">Clientes novos (30%)</div>
        </div>

        <div class="metric-card">
          <div class="metric-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">üîÑ</div>
          <div class="metric-title">Vendas Old</div>
          <div class="metric-value" id="vendasOld">0</div>
          <div class="metric-subtitle">Clientes antigos (20%)</div>
        </div>

        <div class="metric-card">
          <div class="metric-icon" style="background: linear-gradient(135deg, #ec4899, #db2777);">üö∂</div>
          <div class="metric-title">Vendas Walk-in</div>
          <div class="metric-value" id="vendasWalk">0</div>
          <div class="metric-subtitle">Atendimento direto (10%)</div>
        </div>
      </div>

      <!-- Gr√°ficos -->
      <div class="charts-section">
        <div class="chart-card">
          <div class="chart-title">üìà Vendas por M√™s</div>
          <div id="chartVendasMensal" style="height: 300px;"></div>
        </div>

        <div class="chart-card">
          <div class="chart-title">üß≠ Distribui√ß√£o por Tipo</div>
          <div id="chartDistribuicao" style="height: 300px;"></div>
        </div>
      </div>

      <!-- Top Clientes -->
      <div class="full-chart">
        <div class="chart-title">üèÜ Top 5 Clientes</div>
        <div id="chartTopClientes" style="height: 350px;"></div>
      </div>
    </div>
  </div>

  <script>
    // =========================================
    // VARI√ÅVEIS GLOBAIS
    // =========================================
    let dadosAtuais = null;

    // =========================================
    // INICIALIZA√á√ÉO
    // =========================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Dashboard de vendas inicializado');
      google.charts.load('current', {packages:['corechart', 'bar']});
      google.charts.setOnLoadCallback(atualizarDashboard);
    });

    // =========================================
    // ATUALIZAR DASHBOARD
    // =========================================
    function atualizarDashboard() {
      const periodo = document.getElementById('filtroPeriodo').value;
      const dataInicio = document.getElementById('dataInicio').value;
      const dataFim = document.getElementById('dataFim').value;

      setLoadingState(true);
      ocultarMensagens();

      google.script.run
        .withSuccessHandler(onDashboardSuccess)
        .withFailureHandler(onDashboardError)
        .obterDadosDashboard({ periodo, dataInicio, dataFim });
    }

    function onDashboardSuccess(dados) {
      console.log('‚úÖ Dados recebidos:', dados);
      dadosAtuais = dados;
      renderizarDashboard(dados);
      setLoadingState(false);
    }

    function onDashboardError(error) {
      console.error('‚ùå Erro ao carregar dashboard:', error);
      setLoadingState(false);
      mostrarErro('Erro ao carregar dados: ' + error.message);
    }

    // =========================================
    // RENDERIZAR DASHBOARD
    // =========================================
    function renderizarDashboard(dados) {
      // Ocultar loading e mostrar conte√∫do
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'block';

      // Atualizar m√©tricas
      document.getElementById('totalVendas').textContent = `$${dados.totalVendas.toFixed(2)}`;
      document.getElementById('totalComissoes').textContent = `$${dados.totalComissao.toFixed(2)}`;
      document.getElementById('vendasNew').textContent = dados.vendasNew || 0;
      document.getElementById('vendasOld').textContent = dados.vendasOld || 0;
      document.getElementById('vendasWalk').textContent = dados.vendasWalk || 0;

      // Renderizar gr√°ficos
      renderizarGraficoVendasMensal(dados.graficoVendas);
      renderizarGraficoDistribuicao(dados);
      renderizarGraficoTopClientes(dados.topClientes);
    }

    function renderizarGraficoVendasMensal(dadosGrafico) {
      if (!dadosGrafico || dadosGrafico.length === 0) {
        document.getElementById('chartVendasMensal').innerHTML = '<p style="text-align: center; color: #6b7280;">Nenhum dado dispon√≠vel</p>';
        return;
      }

      const data = google.visualization.arrayToDataTable(dadosGrafico);
      const chart = new google.visualization.ColumnChart(document.getElementById('chartVendasMensal'));
      chart.draw(data, {
        legend: { position: 'none' },
        colors: ['#2b5797'],
        vAxis: { title: 'Valor ($)' },
        hAxis: { title: 'M√™s' }
      });
    }

    function renderizarGraficoDistribuicao(dados) {
      const data = google.visualization.arrayToDataTable([
        ['Tipo', 'Quantidade'],
        ['New', dados.vendasNew || 0],
        ['Old', dados.vendasOld || 0],
        ['Walk-in', dados.vendasWalk || 0]
      ]);

      const chart = new google.visualization.PieChart(document.getElementById('chartDistribuicao'));
      chart.draw(data, {
        legend: { position: 'bottom' },
        colors: ['#10b981', '#f59e0b', '#ec4899'],
        pieHole: 0.4
      });
    }

    function renderizarGraficoTopClientes(dadosTop) {
      if (!dadosTop || dadosTop.length === 0) {
        document.getElementById('chartTopClientes').innerHTML = '<p style="text-align: center; color: #6b7280;">Nenhum dado dispon√≠vel</p>';
        return;
      }

      const data = google.visualization.arrayToDataTable(dadosTop);
      const chart = new google.visualization.BarChart(document.getElementById('chartTopClientes'));
      chart.draw(data, {
        legend: { position: 'none' },
        colors: ['#fbbc04'],
        hAxis: { title: 'Valor ($)' },
        vAxis: { title: 'Cliente' }
      });
    }

    // =========================================
    // EXPORTAR RELAT√ìRIO
    // =========================================
    function exportarRelatorio() {
      if (!dadosAtuais) {
        mostrarErro('Carregue os dados antes de exportar.');
        return;
      }

      const btn = document.getElementById('exportBtn');
      const originalText = btn.innerHTML;

      btn.disabled = true;
      btn.innerHTML = '‚è≥ Gerando PDF...';

      google.script.run
        .withSuccessHandler(function(url) {
          btn.disabled = false;
          btn.innerHTML = originalText;
          mostrarSucesso('Relat√≥rio gerado com sucesso!');
          window.open(url, '_blank');
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.innerHTML = originalText;
          mostrarErro('Erro ao gerar relat√≥rio: ' + error.message);
        })
        .gerarRelatorioPDF(dadosAtuais);
    }

    // =========================================
    // UTILIT√ÅRIOS DE UI
    // =========================================
    function setLoadingState(loading) {
      const loadingDiv = document.getElementById('loadingState');
      const btn = document.getElementById('atualizarBtn');
      const btnIcon = document.getElementById('btnIcon');
      const btnText = document.getElementById('btnText');

      loadingDiv.style.display = loading ? 'block' : 'none';
      document.getElementById('dashboardContent').style.display = loading ? 'none' : 'block';

      if (loading) {
        btn.disabled = true;
        btnIcon.innerHTML = '<span style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block;"></span>';
        btnText.textContent = 'Carregando...';
      } else {
        btn.disabled = false;
        btnIcon.textContent = '‚ö°';
        btnText.textContent = 'Atualizar Dados';
      }
    }

    function mostrarSucesso(mensagem) {
      const successDiv = document.getElementById('successMessage');
      const errorDiv = document.getElementById('errorMessage');

      successDiv.textContent = mensagem;
      successDiv.style.display = 'block';
      errorDiv.style.display = 'none';

      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 5000);
    }

    function mostrarErro(mensagem) {
      const successDiv = document.getElementById('successMessage');
      const errorDiv = document.getElementById('errorMessage');

      errorDiv.textContent = mensagem;
      errorDiv.style.display = 'block';
      successDiv.style.display = 'none';
    }

    function ocultarMensagens() {
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }

    function voltarMenu() {
      google.script.run.retornarAoMenuPrincipal();
    }
  </script>
</body>
</html>
