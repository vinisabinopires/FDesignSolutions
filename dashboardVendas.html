<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Dashboard · F/Design Solutions</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f172a;
      --card: rgba(15, 23, 42, 0.88);
      --border: rgba(148, 163, 184, 0.2);
      --accent: #fbbc04;
      --success: #22c55e;
      --danger: #f87171;
      color-scheme: dark;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.18), rgba(15, 23, 42, 0.9));
      color: #e2e8f0;
      min-height: 100vh;
      padding: 36px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    header p {
      margin: 6px 0 0;
      color: rgba(148, 163, 184, 0.85);
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.4);
    }
    .search-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 18px;
    }
    input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.6);
      color: #e2e8f0;
    }
    input::placeholder { color: rgba(148, 163, 184, 0.6); }
    button.primary {
      background: linear-gradient(135deg, var(--accent), #ffd250);
      color: #111827;
      border: none;
      border-radius: 14px;
      padding: 12px 18px;
      font-weight: 600;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      text-align: left;
      font-size: 0.95rem;
    }
    th { color: rgba(148, 163, 184, 0.9); font-weight: 600; }
    tr:hover { background: rgba(59, 130, 246, 0.12); cursor: pointer; }
    .empty { text-align: center; padding: 24px; color: rgba(148, 163, 184, 0.7); }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: min(520px, 90vw);
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 { margin: 0; font-size: 1.3rem; }
    .close-btn {
      background: none;
      border: none;
      color: rgba(148, 163, 184, 0.8);
      font-size: 1.5rem;
      cursor: pointer;
    }
    .actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }
    .actions button {
      border: none;
      border-radius: 12px;
      padding: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-call { background: rgba(59, 130, 246, 0.2); color: #bfdbfe; }
    .btn-msg { background: rgba(45, 212, 191, 0.18); color: #5eead4; }
    .btn-pay { background: rgba(251, 188, 4, 0.2); color: #fde68a; }
    .btn-close { background: rgba(248, 113, 113, 0.18); color: #fecaca; }
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 18px;
      border-radius: 12px;
      background: rgba(59, 130, 246, 0.95);
      color: #0f172a;
      font-weight: 600;
      display: none;
    }
    .toast.error { background: rgba(248, 113, 113, 0.95); color: #111827; }
    .payment-row {
      display: none;
      gap: 10px;
      align-items: center;
    }
    .payment-row input, .payment-row select {
      flex: 1;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Sales dashboard</h1>
      <p>Search and manage every sale recorded in the Client_List sheet.</p>
    </div>
    <button class="primary" type="button" onclick="returnToHub()">← Back to workspace</button>
  </header>

  <section class="card">
    <div class="search-grid">
      <input id="searchClient" placeholder="Client" />
      <input id="searchCompany" placeholder="Company" />
      <input id="searchInvoice" placeholder="Invoice / ID" />
      <input id="searchProduct" placeholder="Product" />
    </div>
    <button class="primary" type="button" onclick="searchSales()">Search sales</button>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Client</th>
          <th>Company</th>
          <th>Product</th>
          <th>Value</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="salesBody">
        <tr><td class="empty" colspan="6">Use the filters above to load sales.</td></tr>
      </tbody>
    </table>
  </section>

  <div id="saleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="saleTitle">Sale details</h2>
        <button class="close-btn" type="button" onclick="closeModal()">×</button>
      </div>
      <div id="saleInfo" style="font-size:0.95rem; line-height:1.5;"></div>
      <div class="actions">
        <button class="btn-call" type="button" onclick="addContact('Call')">Log call</button>
        <button class="btn-msg" type="button" onclick="addContact('Message')">Log message</button>
        <button class="btn-pay" type="button" onclick="togglePayment(true)">Register payment</button>
        <button class="btn-close" type="button" onclick="closeModal()">Close</button>
      </div>
      <div id="paymentSection" class="payment-row">
        <input id="paymentValue" type="number" min="0" step="0.01" placeholder="Amount" />
        <select id="paymentMethod">
          <option value="">Method</option>
          <option value="Cash">Cash</option>
          <option value="Card">Card</option>
          <option value="Check">Check</option>
          <option value="Zelle">Zelle</option>
        </select>
        <button class="primary" type="button" onclick="applyPayment()">Apply</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    let currentSale = null;

    function searchSales() {
      const filters = {
        nome: document.getElementById('searchClient').value.trim(),
        empresa: document.getElementById('searchCompany').value.trim(),
        invoice: document.getElementById('searchInvoice').value.trim(),
        produto: document.getElementById('searchProduct').value.trim(),
      };

      google.script.run
        .withSuccessHandler(renderSales)
        .withFailureHandler(() => showToast('Unable to load sales.', true))
        .buscarVendas(filters);
    }

    function renderSales(sales) {
      const body = document.getElementById('salesBody');
      body.innerHTML = '';
      if (!sales || sales.length === 0) {
        body.innerHTML = '<tr><td class="empty" colspan="6">No sales found.</td></tr>';
        return;
      }
      sales.forEach((sale) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${sale.id || ''}</td>
          <td>${sale.cliente || '-'}</td>
          <td>${sale.empresa || '-'}</td>
          <td>${sale.produto || '-'}</td>
          <td>$${Number(sale.valor || 0).toFixed(2)}</td>
          <td>${sale.status || '-'}</td>
        `;
        row.addEventListener('click', () => openSale(sale));
        body.appendChild(row);
      });
    }

    function openSale(sale) {
      currentSale = sale;
      document.getElementById('saleTitle').textContent = `Sale ${sale.id}`;
      document.getElementById('saleInfo').innerHTML = `
        <strong>Client:</strong> ${sale.cliente || '-'}<br />
        <strong>Company:</strong> ${sale.empresa || '-'}<br />
        <strong>Product:</strong> ${sale.produto || '-'}<br />
        <strong>Value:</strong> $${Number(sale.valor || 0).toFixed(2)}<br />
        <strong>Status:</strong> ${sale.status || '-'}<br />
        <strong>Attempts:</strong> ${sale.tentativas || 0}
      `;
      togglePayment(false);
      document.getElementById('saleModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('saleModal').style.display = 'none';
      togglePayment(false);
      currentSale = null;
    }

    function addContact(type) {
      if (!currentSale) return;
      google.script.run
        .withSuccessHandler((res) => {
          showToast(`${type} logged. Total attempts: ${res.tentativas}`);
          searchSales();
        })
        .withFailureHandler(() => showToast('Unable to log contact.', true))
        .registrarTentativaContato(currentSale.id, type);
    }

    function togglePayment(show) {
      document.getElementById('paymentSection').style.display = show ? 'grid' : 'none';
    }

    function applyPayment() {
      if (!currentSale) return;
      const value = parseFloat(document.getElementById('paymentValue').value || '0');
      const method = document.getElementById('paymentMethod').value;
      if (!value || !method) {
        showToast('Enter payment value and method.', true);
        return;
      }
      google.script.run
        .withSuccessHandler((res) => {
          showToast(`Payment recorded. Total paid $${res.total.toFixed(2)}`);
          togglePayment(false);
          searchSales();
        })
        .withFailureHandler(() => showToast('Unable to register payment.', true))
        .registrarPagamento(currentSale.id, value, method);
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast${isError ? ' error' : ''}`;
      toast.style.display = 'block';
      setTimeout(() => (toast.style.display = 'none'), 2600);
    }

    function returnToHub() {
      google.script.run
        .withSuccessHandler(() => google.script.host.close())
        .withFailureHandler(() => showToast('Unable to return.', true))
        .retornarAoMenuPrincipal();
    }
  </script>
</body>
</html>
