<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Dashboard ‚Äî F/Design Solutions</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; font-family: 'Nunito Sans', sans-serif; }
    body {
      margin: 0; min-height: 100vh; color: #fff;
      background: linear-gradient(135deg, #1b2b5a, #283f87, #2b5797);
      background-size: 300% 300%;
      animation: gradientShift 18s ease infinite;
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      padding: 30px;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .dashboard {
      width: 95%; max-width: 1000px;
      background: rgba(255, 255, 255, 0.07);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px 40px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.35);
      backdrop-filter: blur(14px);
      animation: fadeIn 0.8s ease;
    }
    @keyframes fadeIn { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }

    h1 {
      font-weight: 800; font-size: 2rem; margin: 0 0 6px;
    }
    .subtext {
      color: #e0e6f7; font-size: 1.1rem; margin-bottom: 25px;
    }

    .search-section {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px; margin-bottom: 25px;
    }
    input {
      padding: 12px 16px; border-radius: 10px; border: none; font-size: 1rem;
      background: rgba(255,255,255,0.15); color: #fff;
    }
    input::placeholder { color: rgba(255,255,255,0.6); }
    button {
      padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer;
      font-weight: 700; font-size: 1rem; transition: all 0.25s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, #fbbc04, #ffcc33);
      color: #222;
    }
    .btn-primary:hover { transform: translateY(-2px); }

    table {
      width: 100%; border-collapse: collapse; margin-top: 10px;
      background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden;
    }
    th, td {
      padding: 12px 14px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    th { font-weight: 700; color: #ffdf85; background: rgba(255,255,255,0.08); }
    tr:hover { background: rgba(255,255,255,0.12); cursor: pointer; }

    .empty {
      text-align: center; padding: 25px; font-style: italic; color: rgba(255,255,255,0.6);
    }

    /* MODAL */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      display: none; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background: #fff; color: #222; border-radius: 14px; width: 95%; max-width: 550px;
      padding: 25px 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      animation: popIn 0.3s ease;
    }
    @keyframes popIn { from{opacity:0;transform:scale(0.95);} to{opacity:1;transform:scale(1);} }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid #ddd; margin-bottom: 15px; padding-bottom: 10px;
    }
    .modal-header h2 { font-size: 1.4rem; margin: 0; }
    .close-btn { background:none;border:none;font-size:1.6rem;cursor:pointer; }

    .action-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .action-buttons button {
      flex: 1 1 45%; padding: 10px; font-weight: 600;
      border-radius: 8px; border: none;
    }
    .btn-call { background: #0ea5e9; color: #fff; }
    .btn-msg { background: #10b981; color: #fff; }
    .btn-pay { background: #fbbc04; color: #000; }
    .btn-close { background: #dc2626; color: #fff; }

    .field-group {
      display: flex; gap: 10px; align-items: center; margin-top: 10px;
    }
    .field-group input, .field-group select {
      flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px;
    }

    .toast {
      position: fixed; bottom: 20px; right: 20px; padding: 12px 18px;
      border-radius: 8px; font-weight: 600; display: none;
    }
    .toast.success { background: #16a34a; color: #fff; }
    .toast.error { background: #dc2626; color: #fff; }
  </style>
</head>

<body>

  <!-- üîô BOT√ÉO DE RETORNO -->
<button class="botao-voltar" onclick="voltarHome()">‚Üê Voltar ao Painel</button>

<style>
  .botao-voltar {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(255,255,255,0.08);
    border: 1px solid #fbbc04;
    color: #fbbc04;
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: 0.2s;
    z-index: 9999;
  }
  .botao-voltar:hover {
    background: #fbbc04;
    color: #202124;
  }
</style>

<script>
  function voltarHome() {
    console.log("üîÅ Voltando ao Painel de Vendas...");
    google.script.run
      .withSuccessHandler(() => console.log("‚úÖ Painel principal aberto."))
      .withFailureHandler(err => alert("‚ùå Erro ao voltar: " + err))
      .abrirHomeVendedor();
  }
</script>

  <div class="dashboard">
    <h1>Sales Dashboard</h1>
    <p class="subtext">Search, manage, and update your client sales.</p>

    <div class="search-section">
      <input id="searchClient" placeholder="Client name">
      <input id="searchCompany" placeholder="Company">
      <input id="searchInvoice" placeholder="Invoice #">
      <input id="searchProduct" placeholder="Product">
      <button class="btn-primary" onclick="searchSales()">Search</button>
    </div>

    <table id="salesTable">
      <thead>
        <tr>
          <th>ID</th><th>Client</th><th>Company</th><th>Product</th><th>Value</th><th>Status</th>
        </tr>
      </thead>
      <tbody id="salesBody">
        <tr><td colspan="6" class="empty">No results found</td></tr>
      </tbody>
    </table>
  </div>

  <!-- MODAL -->
  <div id="saleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="saleTitle">Sale Details</h2>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      <div id="saleInfo"></div>

      <div class="action-buttons">
        <button class="btn-call" onclick="addContact('Call')">+ Call</button>
        <button class="btn-msg" onclick="addContact('Message')">+ Message</button>
        <button class="btn-pay" onclick="openPayment()">+ Payment</button>
        <button class="btn-close" onclick="closeSale()">Close Sale</button>
      </div>

      <div id="paymentSection" style="display:none; margin-top:10px;">
        <div class="field-group">
          <input id="paymentValue" type="number" placeholder="Amount ($)" step="0.01" min="0">
          <select id="paymentMethod">
            <option value="">Method</option>
            <option value="Cash">Cash</option>
            <option value="Card">Card</option>
            <option value="Check">Check</option>
            <option value="Zelle">Zelle</option>
          </select>
        </div>
        <button class="btn-primary" style="margin-top:10px;" onclick="applyPayment()">Apply Payment</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    let currentSale = null;

    function searchSales() {
      const filtros = {
        nome: document.getElementById('searchClient').value.trim(),
        empresa: document.getElementById('searchCompany').value.trim(),
        invoice: document.getElementById('searchInvoice').value.trim(),
        produto: document.getElementById('searchProduct').value.trim(),
      };

      google.script.run
        .withSuccessHandler(renderSales)
        .withFailureHandler(err => showToast('Error searching sales', 'error'))
        .buscarVendas(filtros);
    }

    function renderSales(sales) {
      const tbody = document.getElementById('salesBody');
      tbody.innerHTML = '';

      if (!sales || sales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty">No results found</td></tr>';
        return;
      }

      sales.forEach(s => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${s.id}</td>
          <td>${s.cliente}</td>
          <td>${s.empresa}</td>
          <td>${s.produto}</td>
          <td>$${parseFloat(s.valor).toFixed(2)}</td>
          <td>${s.status}</td>
        `;
        row.onclick = () => openSaleDetails(s);
        tbody.appendChild(row);
      });
    }

    function openSaleDetails(sale) {
      currentSale = sale;
      document.getElementById('saleTitle').textContent = `Sale #${sale.id}`;
      document.getElementById('saleInfo').innerHTML = `
        <p><strong>Client:</strong> ${sale.cliente}</p>
        <p><strong>Company:</strong> ${sale.empresa}</p>
        <p><strong>Product:</strong> ${sale.produto}</p>
        <p><strong>Value:</strong> $${parseFloat(sale.valor).toFixed(2)}</p>
        <p><strong>Status:</strong> ${sale.status}</p>
        <p><strong>Attempts:</strong> ${sale.tentativas || 0}</p>
      `;
      document.getElementById('saleModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('saleModal').style.display = 'none';
      document.getElementById('paymentSection').style.display = 'none';
    }

    function addContact(type) {
      if (!currentSale) return;
      google.script.run
        .withSuccessHandler(res => {
          showToast(`${type} logged (${res.tentativas} total)`, 'success');
          searchSales();
        })
        .withFailureHandler(() => showToast('Error adding contact', 'error'))
        .registrarTentativaContato(currentSale.id, type);
    }

    function openPayment() {
      document.getElementById('paymentSection').style.display = 'block';
    }

    function applyPayment() {
      const value = document.getElementById('paymentValue').value;
      const method = document.getElementById('paymentMethod').value;
      if (!value || !method) return showToast('Fill all payment fields', 'error');

      google.script.run
        .withSuccessHandler(res => {
          showToast(`Payment added. Total paid: $${res.total.toFixed(2)}`, 'success');
          document.getElementById('paymentSection').style.display = 'none';
          searchSales();
        })
        .withFailureHandler(() => showToast('Error registering payment', 'error'))
        .registrarPagamento(currentSale.id, parseFloat(value), method);
    }

    function closeSale() {
      showToast('Sale marked as completed ‚úîÔ∏è', 'success');
      closeModal();
    }

    function showToast(msg, type) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = `toast ${type}`;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 2500);
    }
  </script>
</body>
</html>
